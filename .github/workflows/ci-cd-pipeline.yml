name: ğŸš€ CI/CD Pipeline - Authentic Platform

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  REGISTRY: gcr.io
  PROJECT_ID: authentic-prod-464216

jobs:
  # ğŸ§ª Tests y validaciones
  test:
    name: ğŸ§ª Run Tests & Quality Checks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package*.json'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        # Solo instalar en directorios principales de Node.js
        for dir in "apps/yosoy/historia-clinica/backend"; do
          if [ -f "$dir/package.json" ] && [ -f "$dir/package-lock.json" ]; then
            echo "Installing dependencies in $dir"
            cd "$dir" && npm ci && cd - > /dev/null
          elif [ -f "$dir/package.json" ]; then
            echo "Installing dependencies in $dir (using npm install)"
            cd "$dir" && npm install && cd - > /dev/null
          fi
        done
    
    - name: ğŸ” Lint code
      run: |
        # Add linting commands here
        echo "Running lint checks..."
    
    - name: âœ… Run tests
      run: |
        # Add test commands here
        echo "Running tests..."

  # ğŸ—ï¸ Build y Push Images para Dev
  build-dev:
    name: ğŸ—ï¸ Build & Push Dev Images
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/dev'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker gcr.io
    
    - name: ğŸ—ï¸ Build Historia Clinica Backend
      run: |
        IMAGE_TAG=dev-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/yosoy-hc-backend
        
        echo "Building Historia Clinica Backend: $IMAGE_NAME:$IMAGE_TAG"
        
        if [ -f "apps/yosoy/historia-clinica/backend/Dockerfile" ]; then
          docker build -f apps/yosoy/historia-clinica/backend/Dockerfile -t $IMAGE_NAME:$IMAGE_TAG apps/yosoy/historia-clinica/backend
          docker push $IMAGE_NAME:$IMAGE_TAG
          
          # TambiÃ©n tag como 'dev-latest'
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:dev-latest
          docker push $IMAGE_NAME:dev-latest
          
          echo "âœ… Successfully built and pushed Historia Clinica Backend"
        else
          echo "âš ï¸ Dockerfile not found, skipping build"
        fi
        
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

  # ğŸš€ Deploy to Dev Environment
  deploy-dev:
    name: ğŸš€ Deploy to Dev Environment
    runs-on: ubuntu-latest
    needs: build-dev
    if: github.ref == 'refs/heads/dev'
    
    steps:
    - name: ğŸ“ Trigger ArgoCD Sync (Dev)
      run: |
        echo "âœ… Dev deployment triggered automatically by ArgoCD"
        echo "ğŸ” Monitor at: https://argo.authenticfarma.com/applications/authentic-platform-dev"

  # ğŸ“‹ Create Release PR
  create-release-pr:
    name: ğŸ“‹ Create Release PR
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“‹ Create Release PR using GitHub CLI
      run: |
        # Configurar Git
        git config --global user.name "ottofonseca"
        git config --global user.email "ottofonseca@gmail.com"
        
        # Verificar si ya existe un PR abierto de dev -> main
        existing_pr=$(gh pr list --base main --head dev --json number --jq '.[0].number')
        
        if [ "$existing_pr" != "null" ] && [ -n "$existing_pr" ]; then
          echo "PR existente encontrado: #$existing_pr"
          echo "Actualizando PR existente..."
          gh pr edit $existing_pr \
            --title "ğŸš€ Release: Deploy dev changes to production" \
            --body "## ğŸš€ Production Release

        This PR contains validated changes from \`dev\` ready for production deployment.

        ### ğŸ“‹ Changes

        - Auto-generated from successful dev builds
        - All tests passing âœ…
        - GCP Authentication working âœ…

        ### ğŸ›¡ï¸ Pre-deployment Checklist

        - [ ] Review all changes
        - [ ] Verify dev environment testing
        - [ ] Confirm database migrations (if any)
        - [ ] Check breaking changes
        - [ ] Validate configuration updates

        ### ğŸš€ Deployment

        Merging this PR will trigger production deployment via ArgoCD.

        **Monitor deployment**: https://argo.authenticfarma.com/applications/authentic-platform-prod

        **Auto-updated**: $(date -Iseconds)"
        else
          echo "Creando nuevo PR..."
          gh pr create \
            --base main \
            --head dev \
            --title "ğŸš€ Release: Deploy dev changes to production" \
            --body "## ğŸš€ Production Release

        This PR contains validated changes from \`dev\` ready for production deployment.

        ### ğŸ“‹ Changes

        - Auto-generated from successful dev builds
        - All tests passing âœ…
        - GCP Authentication working âœ…

        ### ğŸ›¡ï¸ Pre-deployment Checklist

        - [ ] Review all changes
        - [ ] Verify dev environment testing
        - [ ] Confirm database migrations (if any)
        - [ ] Check breaking changes
        - [ ] Validate configuration updates

        ### ğŸš€ Deployment

        Merging this PR will trigger production deployment via ArgoCD.

        **Monitor deployment**: https://argo.authenticfarma.com/applications/authentic-platform-prod

        **Created**: $(date -Iseconds)" \
            --assignee ottofonseca \
            --label "release,production,auto-generated"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ—ï¸ Build Prod Images (cuando se merge a main)
  build-prod:
    name: ğŸ—ï¸ Build & Push Prod Images
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        app: [yosoy-hc-backend, yosoy-hc-frontend, authenticfarma-backend]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker
    
    - name: ğŸ—ï¸ Build and Push Prod Image
      run: |
        VERSION_TAG=v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ matrix.app }}
        
        # Determinar el dockerfile correcto
        case "${{ matrix.app }}" in
          yosoy-hc-backend)
            DOCKERFILE_PATH="apps/yosoy/historia-clinica/Dockerfile"
            CONTEXT_PATH="apps/yosoy/historia-clinica"
            ;;
          yosoy-hc-frontend)
            DOCKERFILE_PATH="apps/yosoy/historia-clinica/frontend-simple.Dockerfile" 
            CONTEXT_PATH="apps/yosoy/historia-clinica"
            ;;
          authenticfarma-backend)
            DOCKERFILE_PATH="apps/authenticfarma/Dockerfile"
            CONTEXT_PATH="apps/authenticfarma"
            ;;
        esac
        
        echo "Building PRODUCTION image: $IMAGE_NAME:$VERSION_TAG"
        docker build -f $DOCKERFILE_PATH -t $IMAGE_NAME:$VERSION_TAG $CONTEXT_PATH
        docker push $IMAGE_NAME:$VERSION_TAG
        
        # Tag como 'latest' para producciÃ³n
        docker tag $IMAGE_NAME:$VERSION_TAG $IMAGE_NAME:latest
        docker push $IMAGE_NAME:latest
        
        echo "âœ… Production image pushed: $IMAGE_NAME:$VERSION_TAG"

  # ğŸ›¡ï¸ Production Deployment (Manual Approval Required)
  notify-prod-ready:
    name: ğŸ›¡ï¸ Notify Production Ready
    runs-on: ubuntu-latest
    needs: build-prod
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¢ Production Deployment Notification
      run: |
        echo "ğŸš€ PRODUCTION READY"
        echo "ğŸ“‹ New images built and pushed to registry"
        echo "ğŸ›¡ï¸ Manual sync required in ArgoCD for production deployment"
        echo "ğŸ”— ArgoCD: https://argo.authenticfarma.com/applications/authentic-platform-prod"
        echo ""
        echo "ğŸ“ Steps to deploy to production:"
        echo "1. Verify all applications in ArgoCD"
        echo "2. Manually sync production applications"
        echo "3. Monitor deployment status"