name: ğŸš€ CI/CD Pipeline - Authentic Platform

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write
  actions: read
  checks: read

env:
  REGISTRY: us-central1-docker.pkg.dev
  PROJECT_ID: authentic-prod-464216
  REPO_NAME: authenticfarma-repo
  # Vertex AI Configuration
  VERTEX_AI_PROJECT_ID: authentic-prod-464216
  VERTEX_AI_LOCATION: us-central1
  VERTEX_AI_MODEL: gemini-1.5-flash

jobs:
  # ğŸ§ª Tests y validaciones
  test:
    name: ğŸ§ª Run Tests & Quality Checks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package*.json'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        # Solo instalar en directorios principales de Node.js
        for dir in "apps/yosoy/historia-clinica/backend"; do
          if [ -f "$dir/package.json" ] && [ -f "$dir/package-lock.json" ]; then
            echo "Installing dependencies in $dir"
            cd "$dir" && npm ci && cd - > /dev/null
          elif [ -f "$dir/package.json" ]; then
            echo "Installing dependencies in $dir (using npm install)"
            cd "$dir" && npm install && cd - > /dev/null
          fi
        done
    
    - name: ğŸ” Lint code
      run: |
        # Add linting commands here
        echo "Running lint checks..."
    
    - name: âœ… Run tests
      run: |
        # Add test commands here
        echo "Running tests..."

  # ğŸ” Detect Changed Applications
  detect-changes:
    name: ğŸ” Detect Changed Apps
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/dev'
    outputs:
      authenticfarma: ${{ steps.changes.outputs.authenticfarma }}
      yosoy: ${{ steps.changes.outputs.yosoy }}
      isyours: ${{ steps.changes.outputs.isyours }}
      moodle: ${{ steps.changes.outputs.moodle }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” Check for changes
      id: changes
      run: |
        # Fetch main para comparar
        git fetch origin main:main || echo "No main branch"
        
        # Detectar cambios en cada app
        if git diff --name-only HEAD~1 | grep -q "^apps/authenticfarma/"; then
          echo "authenticfarma=true" >> $GITHUB_OUTPUT
          echo "âœ… AuthenticFarma (candidatos) has changes"
        else
          echo "authenticfarma=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ AuthenticFarma (candidatos) no changes"
        fi
        
        if git diff --name-only HEAD~1 | grep -q "^apps/yosoy/"; then
          echo "yosoy=true" >> $GITHUB_OUTPUT
          echo "âœ… YoSoy (historia clinica) has changes"
        else
          echo "yosoy=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ YoSoy (historia clinica) no changes"
        fi
        
        if git diff --name-only HEAD~1 | grep -q "^apps/isyours/"; then
          echo "isyours=true" >> $GITHUB_OUTPUT
          echo "âœ… IsYours has changes"
        else
          echo "isyours=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ IsYours no changes"
        fi
        
        if git diff --name-only HEAD~1 | grep -q "^apps/moodle-elearning/"; then
          echo "moodle=true" >> $GITHUB_OUTPUT
          echo "âœ… Moodle E-Learning has changes"
        else
          echo "moodle=false" >> $GITHUB_OUTPUT
          echo "â­ï¸ Moodle E-Learning no changes"
        fi

  # ğŸ—ï¸ Build AuthenticFarma (Candidatos)
  build-authenticfarma:
    name: ğŸ—ï¸ Build AuthenticFarma (Candidatos)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.authenticfarma == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
    
    - name: ğŸ—ï¸ Build AuthenticFarma Backend (Candidatos)
      run: |
        IMAGE_TAG=dev-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/authenticfarma-backend
        
        echo "Building AuthenticFarma Backend (Candidatos): $IMAGE_NAME:$IMAGE_TAG"
        
        if [ -f "apps/authenticfarma/Dockerfile" ]; then
          docker build -f apps/authenticfarma/Dockerfile -t $IMAGE_NAME:$IMAGE_TAG apps/authenticfarma
          docker push $IMAGE_NAME:$IMAGE_TAG
          
          # TambiÃ©n tag como 'dev-latest'
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:dev-latest
          docker push $IMAGE_NAME:dev-latest
          
          echo "âœ… Successfully built and pushed AuthenticFarma Backend"
        else
          echo "âš ï¸ Dockerfile not found, skipping build"
        fi
        
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

  # ğŸ—ï¸ Build YoSoy (Historia Clinica)  
  build-yosoy:
    name: ğŸ—ï¸ Build YoSoy (Historia Clinica)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.yosoy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ï¿½ Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker gcr.io
    
    - name: ğŸ—ï¸ Build YoSoy Backend
      run: |
        IMAGE_TAG=dev-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/yosoy-hc-backend
        
        if [ -f "apps/yosoy/historia-clinica/backend/Dockerfile" ]; then
          docker build -f apps/yosoy/historia-clinica/backend/Dockerfile -t $IMAGE_NAME:$IMAGE_TAG apps/yosoy/historia-clinica/backend
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:dev-latest
          docker push $IMAGE_NAME:dev-latest
          echo "âœ… YoSoy backend built and pushed"
        fi

  # ğŸ—ï¸ Build IsYours
  build-isyours:
    name: ğŸ—ï¸ Build IsYours
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.isyours == 'true'
    
    steps:
    - name: ï¿½ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker gcr.io
    
    - name: ğŸ—ï¸ Build IsYours
      run: |
        IMAGE_TAG=dev-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/isyours
        
        if [ -f "apps/isyours/Dockerfile" ]; then
          docker build -f apps/isyours/Dockerfile -t $IMAGE_NAME:$IMAGE_TAG apps/isyours
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:dev-latest
          docker push $IMAGE_NAME:dev-latest
          echo "âœ… IsYours built and pushed"
        fi

  # ğŸ—ï¸ Build Moodle E-Learning
  build-moodle:
    name: ğŸ—ï¸ Build Moodle E-Learning
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.moodle == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker gcr.io
    
    - name: ğŸ—ï¸ Build Moodle
      run: |
        IMAGE_TAG=dev-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/moodle-elearning
        
        if [ -f "apps/moodle-elearning/Dockerfile" ]; then
          docker build -f apps/moodle-elearning/Dockerfile -t $IMAGE_NAME:$IMAGE_TAG apps/moodle-elearning
          docker push $IMAGE_NAME:$IMAGE_TAG
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:dev-latest
          docker push $IMAGE_NAME:dev-latest
          echo "âœ… Moodle built and pushed"
        fi

  # ï¿½ğŸš€ Deploy to Dev Environment
  deploy-dev:
    name: ğŸš€ Deploy to Dev Environment
    runs-on: ubuntu-latest
    needs: [detect-changes, build-authenticfarma, build-yosoy, build-isyours, build-moodle]
    if: |
      always() && 
      (needs.detect-changes.result == 'success') &&
      (
        (needs.build-authenticfarma.result == 'success') ||
        (needs.build-yosoy.result == 'success') ||
        (needs.build-isyours.result == 'success') ||
        (needs.build-moodle.result == 'success') ||
        (needs.build-authenticfarma.result == 'skipped' && 
         needs.build-yosoy.result == 'skipped' && 
         needs.build-isyours.result == 'skipped' && 
         needs.build-moodle.result == 'skipped')
      )
    
    steps:
    - name: ğŸ“ Trigger ArgoCD Sync (Dev)
      run: |
        echo "âœ… Dev deployment triggered automatically by ArgoCD"
        echo "ğŸ” Monitor at: https://argo.authenticfarma.com/applications/authentic-platform-dev"

  # ğŸ“‹ Create Release PR
  create-release-pr:
    name: ğŸ“‹ Create Release PR
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“‹ Create Release PR using GitHub CLI
      run: |
        # Configurar Git
        git config --global user.name "authentic-24"
        git config --global user.email "stack.dev@authentic.com.co"
        
        # Fetch main branch para poder comparar
        git fetch origin main:main
        
        # Verificar si ya existe un PR abierto de dev -> main
        existing_pr=$(gh pr list --base main --head dev --json number --jq '.[0].number')
        
        if [ "$existing_pr" != "null" ] && [ -n "$existing_pr" ]; then
          echo "âœ… PR existente encontrado: #$existing_pr"
          echo "ğŸ”— URL: https://github.com/desarrolloIngenios/authentic-platform/pull/$existing_pr"
          echo ""
          echo "â„¹ï¸ No es necesario crear un nuevo PR."
          echo "ğŸ“‹ El PR existente ya contiene todos los cambios de dev."
          echo "ï¿½ Para desplegar a producciÃ³n, hacer merge del PR existente."
          echo ""
          echo "ğŸ“Š Cambios incluidos en el PR:"
          git log main..dev --oneline --max-count=5
        else
          echo "Creando nuevo PR..."
          gh pr create \
            --base main \
            --head dev \
            --title "ğŸš€ Release: Deploy dev changes to production" \
            --body "## ğŸš€ Production Release

        This PR contains validated changes from \`dev\` ready for production deployment.

        ### ğŸ“‹ Changes

        - Auto-generated from successful dev builds
        - All tests passing âœ…
        - GCP Authentication working âœ…

        ### ğŸ›¡ï¸ Pre-deployment Checklist

        - [ ] Review all changes
        - [ ] Verify dev environment testing
        - [ ] Confirm database migrations (if any)
        - [ ] Check breaking changes
        - [ ] Validate configuration updates

        ### ğŸš€ Deployment

        Merging this PR will trigger production deployment via ArgoCD.

        **Monitor deployment**: https://argo.authenticfarma.com/applications/authentic-platform-prod

        **Created**: $(date -Iseconds)"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ğŸ” Detect Changes for Production
  detect-changes-prod:
    name: ğŸ” Detect Changes for Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      authenticfarma: ${{ steps.changes.outputs.authenticfarma }}
      yosoy: ${{ steps.changes.outputs.yosoy }}
      isyours: ${{ steps.changes.outputs.isyours }}
      moodle: ${{ steps.changes.outputs.moodle }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ğŸ” Detect app changes
      id: changes
      run: |
        # Compare with previous commit for main branch
        echo "ğŸ” Detecting changes in applications for production..."
        
        # Check if any files changed in each app
        if git diff --quiet HEAD~1 HEAD -- apps/authenticfarma/; then
          echo "authenticfarma=false" >> $GITHUB_OUTPUT
          echo "âŒ AuthenticFarma: No changes"
        else
          echo "authenticfarma=true" >> $GITHUB_OUTPUT
          echo "âœ… AuthenticFarma: Changes detected"
        fi
        
        if git diff --quiet HEAD~1 HEAD -- apps/yosoy/; then
          echo "yosoy=false" >> $GITHUB_OUTPUT
          echo "âŒ YoSoy: No changes"
        else
          echo "yosoy=true" >> $GITHUB_OUTPUT
          echo "âœ… YoSoy: Changes detected"
        fi
        
        if git diff --quiet HEAD~1 HEAD -- apps/isyours/; then
          echo "isyours=false" >> $GITHUB_OUTPUT
          echo "âŒ IsYours: No changes"
        else
          echo "isyours=true" >> $GITHUB_OUTPUT
          echo "âœ… IsYours: Changes detected"
        fi
        
        if git diff --quiet HEAD~1 HEAD -- apps/moodle-elearning/; then
          echo "moodle=false" >> $GITHUB_OUTPUT
          echo "âŒ Moodle: No changes"
        else
          echo "moodle=true" >> $GITHUB_OUTPUT
          echo "âœ… Moodle: Changes detected"
        fi

  # ğŸ—ï¸ Production Build - AuthenticFarma
  build-prod-authenticfarma:
    name: ğŸ—ï¸ Build AuthenticFarma for Production
    runs-on: ubuntu-latest
    needs: detect-changes-prod
    if: needs.detect-changes-prod.outputs.authenticfarma == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
    
    - name: ğŸ¤– Setup Vertex AI Credentials  
      run: |
        echo "Setting up Vertex AI credentials for AuthenticFarma..."
        echo "Service Account: laravel-gemini-prod@authentic-prod-464216.iam.gserviceaccount.com"
        echo '${{ secrets.VERTEX_AI_PRODUCTION }}' > /tmp/vertex-ai-credentials.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/vertex-ai-credentials.json" >> $GITHUB_ENV
        
        # Verify credentials file
        if [ -f "/tmp/vertex-ai-credentials.json" ]; then
          echo "âœ… Vertex AI credentials file created successfully"
          # Validate JSON format (without exposing content)
          if jq empty /tmp/vertex-ai-credentials.json 2>/dev/null; then
            echo "âœ… Vertex AI credentials JSON is valid"
          else
            echo "âŒ Invalid JSON format in Vertex AI credentials"
            exit 1
          fi
        else
          echo "âŒ Failed to create Vertex AI credentials file"
          exit 1
        fi
        
    - name: ğŸ—ï¸ Build AuthenticFarma Candidatos
      run: |
        VERSION_TAG=v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/authentic-candidatos
        
        echo "Building PRODUCTION image with Vertex AI support: $IMAGE_NAME:$VERSION_TAG"
        
        # Prepare Vertex AI credentials for container deployment
        if [ -f "/tmp/vertex-ai-credentials.json" ]; then
          echo "âœ… Vertex AI credentials available for runtime deployment"
        else
          echo "âš ï¸ Vertex AI credentials not found - using placeholder (AI features will be limited)"
        fi
        
        # Build with Vertex AI environment variables
        docker build \
          --build-arg VERTEX_AI_PROJECT_ID=${{ env.VERTEX_AI_PROJECT_ID }} \
          --build-arg VERTEX_AI_LOCATION=${{ env.VERTEX_AI_LOCATION }} \
          --build-arg VERTEX_AI_MODEL=${{ env.VERTEX_AI_MODEL }} \
          --build-arg GOOGLE_APPLICATION_CREDENTIALS=/var/www/storage/vertex-ai-credentials.json \
          -f apps/authenticfarma/candidatos/dockerfile \
          -t $IMAGE_NAME:$VERSION_TAG \
          apps/authenticfarma/candidatos
        
        docker push $IMAGE_NAME:$VERSION_TAG
        
        docker tag $IMAGE_NAME:$VERSION_TAG $IMAGE_NAME:latest
        docker push $IMAGE_NAME:latest
        
        echo "âœ… Production image pushed: $IMAGE_NAME:$VERSION_TAG"

  # ğŸ—ï¸ Production Build - YoSoy
  build-prod-yosoy:
    name: ğŸ—ï¸ Build YoSoy for Production  
    runs-on: ubuntu-latest
    needs: detect-changes-prod
    if: needs.detect-changes-prod.outputs.yosoy == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
    
    - name: ğŸ—ï¸ Build YoSoy Backend
      run: |
        VERSION_TAG=v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/yosoy-repo/yosoy-hc-backend
        
        echo "Building PRODUCTION image: $IMAGE_NAME:$VERSION_TAG"
        
        if [ -f "apps/yosoy/historia-clinica/backend/Dockerfile" ]; then
          docker build -f apps/yosoy/historia-clinica/backend/Dockerfile -t $IMAGE_NAME:$VERSION_TAG apps/yosoy/historia-clinica/backend
          docker push $IMAGE_NAME:$VERSION_TAG
          docker tag $IMAGE_NAME:$VERSION_TAG $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
          echo "âœ… YoSoy production image pushed: $IMAGE_NAME:$VERSION_TAG"
        fi

  # ğŸ—ï¸ Production Build - IsYours
  build-prod-isyours:
    name: ğŸ—ï¸ Build IsYours for Production
    runs-on: ubuntu-latest
    needs: detect-changes-prod
    if: needs.detect-changes-prod.outputs.isyours == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
    
    - name: ğŸ—ï¸ Build IsYours
      run: |
        VERSION_TAG=v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/isyours-repo/isyoursapp
        
        echo "Building PRODUCTION image: $IMAGE_NAME:$VERSION_TAG"
        
        if [ -f "apps/isyours/Dockerfile" ]; then
          docker build -f apps/isyours/Dockerfile -t $IMAGE_NAME:$VERSION_TAG apps/isyours
          docker push $IMAGE_NAME:$VERSION_TAG
          docker tag $IMAGE_NAME:$VERSION_TAG $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
          echo "âœ… IsYours production image pushed: $IMAGE_NAME:$VERSION_TAG"
        fi

  # ğŸ—ï¸ Production Build - Moodle
  build-prod-moodle:
    name: ğŸ—ï¸ Build Moodle for Production
    runs-on: ubuntu-latest
    needs: detect-changes-prod
    if: needs.detect-changes-prod.outputs.moodle == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Auth to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ“‹ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: ğŸ³ Configure Docker  
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
    
    - name: ğŸ—ï¸ Build Moodle
      run: |
        VERSION_TAG=v$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)
        IMAGE_NAME=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/moodle-repo/moodle-elearning
        
        echo "Building PRODUCTION image: $IMAGE_NAME:$VERSION_TAG"
        
        if [ -f "apps/moodle-elearning/Dockerfile" ]; then
          docker build -f apps/moodle-elearning/Dockerfile -t $IMAGE_NAME:$VERSION_TAG apps/moodle-elearning
          docker push $IMAGE_NAME:$VERSION_TAG
          docker tag $IMAGE_NAME:$VERSION_TAG $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
          echo "âœ… Moodle production image pushed: $IMAGE_NAME:$VERSION_TAG"
        fi

  # ğŸ›¡ï¸ Production Deployment (Manual Approval Required)
  notify-prod-ready:
    name: ğŸ›¡ï¸ Notify Production Ready
    runs-on: ubuntu-latest
    needs: [detect-changes-prod, build-prod-authenticfarma, build-prod-yosoy, build-prod-isyours, build-prod-moodle]
    if: |
      always() && 
      (needs.detect-changes-prod.result == 'success') &&
      (
        (needs.build-prod-authenticfarma.result == 'success') ||
        (needs.build-prod-yosoy.result == 'success') ||
        (needs.build-prod-isyours.result == 'success') ||
        (needs.build-prod-moodle.result == 'success') ||
        (needs.build-prod-authenticfarma.result == 'skipped' && 
         needs.build-prod-yosoy.result == 'skipped' && 
         needs.build-prod-isyours.result == 'skipped' && 
         needs.build-prod-moodle.result == 'skipped')
      )
    
    steps:
    - name: ğŸ“¢ Production Deployment Notification
      run: |
        echo "ğŸš€ PRODUCTION READY"
        echo "ğŸ“‹ New images built and pushed to registry"
        echo "ğŸ›¡ï¸ Manual sync required in ArgoCD for production deployment"
        echo "ğŸ”— ArgoCD: https://argo.authenticfarma.com/applications/authentic-platform-prod"
        echo ""
        echo "ğŸ“ Steps to deploy to production:"
        echo "1. Verify all applications in ArgoCD"
        echo "2. Manually sync production applications"
        echo "3. Monitor deployment status"