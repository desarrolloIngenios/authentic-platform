<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historia Clínica - Sistema Médico</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html2canvas@latest/dist/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .medical-form { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .form-section { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .medical-card { transition: all 0.3s ease; }
        .medical-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .search-highlight { background-color: #fbbf24; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // Utilidades de seguridad
        const SecurityUtils = {
            encrypt: (data) => {
                try {
                    return btoa(JSON.stringify(data));
                } catch (e) {
                    console.error('Error al encriptar:', e);
                    return null;
                }
            },
            decrypt: (encryptedData) => {
                try {
                    return JSON.parse(atob(encryptedData));
                } catch (e) {
                    console.error('Error al desencriptar:', e);
                    return null;
                }
            },
            hashPassword: (password) => {
                return btoa(password + 'salt_secure_2024');
            },
            generateSessionToken: () => {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
        };

        // Sistema de auditoria simplificado
        const AuditSystem = {
            log: (action, userId, details) => {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    action,
                    userId,
                    details,
                    sessionId: sessionStorage.getItem('sessionId')
                };
                
                const existingLogs = SecurityUtils.decrypt(localStorage.getItem('auditLogs')) || [];
                existingLogs.push(logEntry);
                localStorage.setItem('auditLogs', SecurityUtils.encrypt(existingLogs));
            }
        };

        // Usuarios del sistema
        const SYSTEM_USERS = [
            {
                id: 1,
                username: 'admin',
                password: SecurityUtils.hashPassword('admin123'),
                role: 'administrador',
                name: 'Dr. Admin',
                email: 'admin@clinica.com',
                permissions: ['all']
            },
            {
                id: 2,
                username: 'doctor',
                password: SecurityUtils.hashPassword('doctor123'),
                role: 'doctor',
                name: 'Dr. García',
                email: 'doctor@clinica.com',
                permissions: ['read_patients', 'write_patients', 'create_prescriptions']
            }
        ];

        // Hook de autenticación
        const useAuth = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const sessionToken = sessionStorage.getItem('sessionToken');
                const encryptedUser = sessionStorage.getItem('currentUser');
                
                if (sessionToken && encryptedUser) {
                    const userData = SecurityUtils.decrypt(encryptedUser);
                    if (userData) {
                        setUser(userData);
                        AuditSystem.log('SESSION_RESTORED', userData.id, { username: userData.username });
                    }
                }
                setLoading(false);
            }, []);

            const login = (username, password) => {
                const user = SYSTEM_USERS.find(u => 
                    u.username === username && u.password === SecurityUtils.hashPassword(password)
                );
                
                if (user) {
                    const sessionToken = SecurityUtils.generateSessionToken();
                    const userSession = { ...user };
                    delete userSession.password;
                    
                    sessionStorage.setItem('sessionToken', sessionToken);
                    sessionStorage.setItem('sessionId', sessionToken);
                    sessionStorage.setItem('currentUser', SecurityUtils.encrypt(userSession));
                    
                    setUser(userSession);
                    AuditSystem.log('LOGIN_SUCCESS', user.id, { username: user.username });
                    return true;
                }
                
                AuditSystem.log('LOGIN_FAILED', null, { username });
                return false;
            };

            const logout = () => {
                if (user) {
                    AuditSystem.log('LOGOUT', user.id, { username: user.username });
                }
                sessionStorage.clear();
                setUser(null);
            };

            return { user, login, logout, loading };
        };

        // Hook para datos médicos
        const useMedicalData = () => {
            const [historias, setHistorias] = useState([]);
            const [formulas, setFormulas] = useState([]);
            const [citas, setCitas] = useState([]);

            useEffect(() => {
                const loadedHistorias = SecurityUtils.decrypt(localStorage.getItem('historias_clinicas')) || [];
                const loadedFormulas = SecurityUtils.decrypt(localStorage.getItem('formulas_medicas')) || [];
                const loadedCitas = SecurityUtils.decrypt(localStorage.getItem('citas_medicas')) || [];
                
                setHistorias(loadedHistorias);
                setFormulas(loadedFormulas);
                setCitas(loadedCitas);
            }, []);

            const saveHistoria = (historia) => {
                const newHistoria = {
                    ...historia,
                    id: Date.now(),
                    fechaCreacion: new Date().toISOString(),
                    userId: sessionStorage.getItem('sessionId')
                };
                
                const updatedHistorias = [...historias, newHistoria];
                setHistorias(updatedHistorias);
                localStorage.setItem('historias_clinicas', SecurityUtils.encrypt(updatedHistorias));
                
                AuditSystem.log('HISTORIA_CREATED', newHistoria.userId, { 
                    paciente: newHistoria.nombrePaciente,
                    historiaId: newHistoria.id 
                });
            };

            const saveFormula = (formula) => {
                const newFormula = {
                    ...formula,
                    id: Date.now(),
                    fechaCreacion: new Date().toISOString(),
                    userId: sessionStorage.getItem('sessionId')
                };
                
                const updatedFormulas = [...formulas, newFormula];
                setFormulas(updatedFormulas);
                localStorage.setItem('formulas_medicas', SecurityUtils.encrypt(updatedFormulas));
                
                AuditSystem.log('FORMULA_CREATED', newFormula.userId, { 
                    paciente: newFormula.nombrePaciente,
                    formulaId: newFormula.id 
                });
            };

            const saveCita = (cita) => {
                const newCita = {
                    ...cita,
                    id: Date.now(),
                    fechaCreacion: new Date().toISOString(),
                    userId: sessionStorage.getItem('sessionId')
                };
                
                const updatedCitas = [...citas, newCita];
                setCitas(updatedCitas);
                localStorage.setItem('citas_medicas', SecurityUtils.encrypt(updatedCitas));
                
                AuditSystem.log('CITA_CREATED', newCita.userId, { 
                    paciente: newCita.paciente,
                    citaId: newCita.id 
                });
            };

            return {
                historias,
                formulas,
                citas,
                saveHistoria,
                saveFormula,
                saveCita
            };
        };

        // Componente de login
        const LoginForm = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (onLogin(username, password)) {
                    setError('');
                } else {
                    setError('Credenciales inválidas');
                }
            };

            return (
                <div className="min-h-screen medical-form flex items-center justify-center p-4">
                    <div className="form-section border border-white/20 rounded-xl p-8 w-full max-w-md">
                        <h2 className="text-white text-2xl font-bold mb-6 text-center">
                            Sistema Médico - Historia Clínica
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input
                                    type="text"
                                    placeholder="Usuario"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/70"
                                    required
                                />
                            </div>
                            <div>
                                <input
                                    type="password"
                                    placeholder="Contraseña"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/70"
                                    required
                                />
                            </div>
                            {error && (
                                <div className="text-red-300 text-sm text-center">{error}</div>
                            )}
                            <button
                                type="submit"
                                className="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-3 px-4 rounded-lg transition duration-300"
                            >
                                Iniciar Sesión
                            </button>
                        </form>
                        <div className="mt-4 text-white/70 text-sm text-center">
                            <p>Usuarios de prueba:</p>
                            <p>admin / admin123</p>
                            <p>doctor / doctor123</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Formulario de Historia Clínica
        const HistoriaClinicaForm = ({ onSave }) => {
            const [formData, setFormData] = useState({
                nombrePaciente: '',
                fechaNacimiento: '',
                edad: '',
                motivoConsulta: '',
                antecedentes: '',
                examenFisico: '',
                diagnostico: '',
                analisis: '',
                planManejo: ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));

                // Calcular edad automáticamente
                if (name === 'fechaNacimiento' && value) {
                    const today = new Date();
                    const birthDate = new Date(value);
                    const age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    
                    setFormData(prev => ({
                        ...prev,
                        edad: age.toString()
                    }));
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
                setFormData({
                    nombrePaciente: '',
                    fechaNacimiento: '',
                    edad: '',
                    motivoConsulta: '',
                    antecedentes: '',
                    examenFisico: '',
                    diagnostico: '',
                    analisis: '',
                    planManejo: ''
                });
                alert('Historia clínica guardada exitosamente');
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-2xl font-bold text-gray-800 mb-6">Historia Clínica</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Nombre del paciente:
                                </label>
                                <input
                                    type="text"
                                    name="nombrePaciente"
                                    value={formData.nombrePaciente}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Fecha de nacimiento:
                                </label>
                                <input
                                    type="date"
                                    name="fechaNacimiento"
                                    value={formData.fechaNacimiento}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Edad:
                                </label>
                                <input
                                    type="number"
                                    name="edad"
                                    value={formData.edad}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Motivo de consulta:
                            </label>
                            <textarea
                                name="motivoConsulta"
                                value={formData.motivoConsulta}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Antecedentes:
                            </label>
                            <textarea
                                name="antecedentes"
                                value={formData.antecedentes}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Examen físico:
                            </label>
                            <textarea
                                name="examenFisico"
                                value={formData.examenFisico}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Diagnóstico:
                            </label>
                            <textarea
                                name="diagnostico"
                                value={formData.diagnostico}
                                onChange={handleChange}
                                rows="2"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Análisis:
                            </label>
                            <textarea
                                name="analisis"
                                value={formData.analisis}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Plan de manejo:
                            </label>
                            <textarea
                                name="planManejo"
                                value={formData.planManejo}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <button
                            type="submit"
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
                        >
                            🔒 Guardar Historia Clínica
                        </button>
                    </form>
                </div>
            );
        };

        // Formulario de Fórmula Médica
        const FormulaMedicaForm = ({ onSave }) => {
            const [formData, setFormData] = useState({
                nombrePaciente: '',
                fecha: new Date().toISOString().split('T')[0],
                medicamentos: '',
                indicaciones: ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
                setFormData({
                    nombrePaciente: '',
                    fecha: new Date().toISOString().split('T')[0],
                    medicamentos: '',
                    indicaciones: ''
                });
                alert('Fórmula médica guardada exitosamente');
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-2xl font-bold text-gray-800 mb-6">Fórmula Médica</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Nombre del paciente:
                                </label>
                                <input
                                    type="text"
                                    name="nombrePaciente"
                                    value={formData.nombrePaciente}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Fecha:
                                </label>
                                <input
                                    type="date"
                                    name="fecha"
                                    value={formData.fecha}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Medicamentos:
                            </label>
                            <textarea
                                name="medicamentos"
                                value={formData.medicamentos}
                                onChange={handleChange}
                                rows="4"
                                placeholder="Escriba los medicamentos con dosificación y frecuencia..."
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Indicaciones:
                            </label>
                            <textarea
                                name="indicaciones"
                                value={formData.indicaciones}
                                onChange={handleChange}
                                rows="3"
                                placeholder="Indicaciones especiales para el paciente..."
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                required
                            />
                        </div>

                        <button
                            type="submit"
                            className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
                        >
                            💊 Guardar Fórmula Médica
                        </button>
                    </form>
                </div>
            );
        };

        // Búsqueda de Pacientes
        const BusquedaPacientes = ({ historias, formulas }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [searchResults, setSearchResults] = useState([]);

            const handleSearch = () => {
                if (!searchTerm.trim()) {
                    setSearchResults([]);
                    return;
                }

                // Buscar en historias clínicas
                const historiasEncontradas = historias.filter(h => 
                    h.nombrePaciente.toLowerCase().includes(searchTerm.toLowerCase())
                );

                // Buscar en fórmulas
                const formulasEncontradas = formulas.filter(f => 
                    f.nombrePaciente.toLowerCase().includes(searchTerm.toLowerCase())
                );

                // Crear un mapa de pacientes únicos
                const pacientesMap = new Map();

                historiasEncontradas.forEach(h => {
                    if (!pacientesMap.has(h.nombrePaciente)) {
                        pacientesMap.set(h.nombrePaciente, {
                            nombre: h.nombrePaciente,
                            historias: [],
                            formulas: []
                        });
                    }
                    pacientesMap.get(h.nombrePaciente).historias.push(h);
                });

                formulasEncontradas.forEach(f => {
                    if (!pacientesMap.has(f.nombrePaciente)) {
                        pacientesMap.set(f.nombrePaciente, {
                            nombre: f.nombrePaciente,
                            historias: [],
                            formulas: []
                        });
                    }
                    pacientesMap.get(f.nombrePaciente).formulas.push(f);
                });

                setSearchResults(Array.from(pacientesMap.values()));
            };

            const viewPatientDetails = (patient) => {
                setSelectedPatient(patient);
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-2xl font-bold text-gray-800 mb-6">Buscar Paciente</h3>
                    
                    <div className="flex gap-4 mb-6">
                        <input
                            type="text"
                            placeholder="Nombre del paciente..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                        <button
                            onClick={handleSearch}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-300"
                        >
                            🔍 Buscar
                        </button>
                    </div>

                    {searchResults.length > 0 && (
                        <div className="space-y-4">
                            <h4 className="text-lg font-semibold text-gray-700">Resultados:</h4>
                            {searchResults.map((patient, index) => (
                                <div key={index} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h5 className="font-semibold text-gray-800">{patient.nombre}</h5>
                                            <p className="text-sm text-gray-600">
                                                {patient.historias.length} historias clínicas • {patient.formulas.length} fórmulas médicas
                                            </p>
                                        </div>
                                        <button
                                            onClick={() => viewPatientDetails(patient)}
                                            className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm transition duration-300"
                                        >
                                            Ver Detalles
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {selectedPatient && (
                        <div className="mt-8 border-t pt-6">
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="text-xl font-bold text-gray-800">
                                    Historial Médico: {selectedPatient.nombre}
                                </h4>
                                <button
                                    onClick={() => setSelectedPatient(null)}
                                    className="text-gray-500 hover:text-gray-700"
                                >
                                    ✕ Cerrar
                                </button>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <h5 className="font-semibold text-gray-700 mb-3">Historias Clínicas ({selectedPatient.historias.length})</h5>
                                    <div className="space-y-3 max-h-60 overflow-y-auto">
                                        {selectedPatient.historias.map((historia, index) => (
                                            <div key={index} className="bg-blue-50 p-3 rounded-lg">
                                                <p className="text-sm text-gray-600 mb-1">
                                                    {new Date(historia.fechaCreacion).toLocaleDateString()}
                                                </p>
                                                <p className="font-medium text-gray-800">
                                                    {historia.diagnostico}
                                                </p>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    Motivo: {historia.motivoConsulta}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <h5 className="font-semibold text-gray-700 mb-3">Fórmulas Médicas ({selectedPatient.formulas.length})</h5>
                                    <div className="space-y-3 max-h-60 overflow-y-auto">
                                        {selectedPatient.formulas.map((formula, index) => (
                                            <div key={index} className="bg-green-50 p-3 rounded-lg">
                                                <p className="text-sm text-gray-600 mb-1">
                                                    {new Date(formula.fechaCreacion).toLocaleDateString()}
                                                </p>
                                                <p className="font-medium text-gray-800">
                                                    {formula.medicamentos}
                                                </p>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    {formula.indicaciones}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Dashboard con Estadísticas
        const Dashboard = ({ historias, formulas, citas }) => {
            const [stats, setStats] = useState({
                totalPacientes: 0,
                totalHistorias: 0,
                totalFormulas: 0,
                totalCitas: 0,
                topDiagnosticos: [],
                topMedicamentos: [],
                edadPromedio: 0
            });

            useEffect(() => {
                // Calcular estadísticas
                const pacientesUnicos = new Set();
                const diagnosticos = {};
                const medicamentos = {};
                let totalEdad = 0;
                let pacientesConEdad = 0;

                historias.forEach(h => {
                    pacientesUnicos.add(h.nombrePaciente);
                    
                    if (h.diagnostico) {
                        diagnosticos[h.diagnostico] = (diagnosticos[h.diagnostico] || 0) + 1;
                    }
                    
                    if (h.edad) {
                        totalEdad += parseInt(h.edad);
                        pacientesConEdad++;
                    }
                });

                formulas.forEach(f => {
                    pacientesUnicos.add(f.nombrePaciente);
                    
                    if (f.medicamentos) {
                        const meds = f.medicamentos.split(',');
                        meds.forEach(med => {
                            const medName = med.trim().split(' ')[0];
                            if (medName) {
                                medicamentos[medName] = (medicamentos[medName] || 0) + 1;
                            }
                        });
                    }
                });

                const topDiagnosticos = Object.entries(diagnosticos)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([diag, count]) => ({ name: diag, count }));

                const topMedicamentos = Object.entries(medicamentos)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([med, count]) => ({ name: med, count }));

                setStats({
                    totalPacientes: pacientesUnicos.size,
                    totalHistorias: historias.length,
                    totalFormulas: formulas.length,
                    totalCitas: citas.length,
                    topDiagnosticos,
                    topMedicamentos,
                    edadPromedio: pacientesConEdad > 0 ? Math.round(totalEdad / pacientesConEdad) : 0
                });
            }, [historias, formulas, citas]);

            return (
                <div className="space-y-6">
                    <h3 className="text-2xl font-bold text-gray-800">Dashboard - Estadísticas</h3>
                    
                    {/* Tarjetas de estadísticas */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="stat-card text-white rounded-xl p-6">
                            <h4 className="text-lg font-semibold mb-2">Total Pacientes</h4>
                            <p className="text-3xl font-bold">{stats.totalPacientes}</p>
                        </div>
                        <div className="stat-card text-white rounded-xl p-6">
                            <h4 className="text-lg font-semibold mb-2">Historias Clínicas</h4>
                            <p className="text-3xl font-bold">{stats.totalHistorias}</p>
                        </div>
                        <div className="stat-card text-white rounded-xl p-6">
                            <h4 className="text-lg font-semibold mb-2">Fórmulas Médicas</h4>
                            <p className="text-3xl font-bold">{stats.totalFormulas}</p>
                        </div>
                        <div className="stat-card text-white rounded-xl p-6">
                            <h4 className="text-lg font-semibold mb-2">Edad Promedio</h4>
                            <p className="text-3xl font-bold">{stats.edadPromedio} años</p>
                        </div>
                    </div>

                    {/* Predictores de salud */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h4 className="text-lg font-bold text-gray-800 mb-4">Diagnósticos Más Frecuentes</h4>
                            <div className="space-y-3">
                                {stats.topDiagnosticos.map((diag, index) => (
                                    <div key={index} className="flex justify-between items-center">
                                        <span className="text-gray-700">{diag.name}</span>
                                        <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                            {diag.count}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h4 className="text-lg font-bold text-gray-800 mb-4">Medicamentos Más Recetados</h4>
                            <div className="space-y-3">
                                {stats.topMedicamentos.map((med, index) => (
                                    <div key={index} className="flex justify-between items-center">
                                        <span className="text-gray-700">{med.name}</span>
                                        <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                            {med.count}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Predictor de salud simplificado */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h4 className="text-lg font-bold text-gray-800 mb-4">Predictor de Salud</h4>
                        <div className="bg-blue-50 p-4 rounded-lg">
                            <p className="text-gray-700">
                                <strong>Análisis basado en datos actuales:</strong>
                            </p>
                            <ul className="list-disc list-inside mt-2 text-gray-600">
                                {stats.totalPacientes > 0 && (
                                    <li>Promedio de {(stats.totalHistorias / stats.totalPacientes).toFixed(1)} consultas por paciente</li>
                                )}
                                {stats.topDiagnosticos.length > 0 && (
                                    <li>Diagnóstico más común: {stats.topDiagnosticos[0]?.name}</li>
                                )}
                                {stats.edadPromedio > 0 && (
                                    <li>Población principalmente {stats.edadPromedio < 30 ? 'joven' : stats.edadPromedio < 60 ? 'adulta' : 'mayor'}</li>
                                )}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        // Agenda con videoconsultas
        const Agenda = ({ citas, onSaveCita }) => {
            const [formData, setFormData] = useState({
                paciente: '',
                fecha: '',
                hora: '',
                motivo: '',
                tipo: 'presencial'
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSaveCita(formData);
                setFormData({
                    paciente: '',
                    fecha: '',
                    hora: '',
                    motivo: '',
                    tipo: 'presencial'
                });
                alert('Cita agendada exitosamente');
            };

            const generateMeetLink = (cita) => {
                const meetId = 'meet-' + cita.id + '-' + Date.now();
                return `https://meet.google.com/${meetId}`;
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h3 className="text-2xl font-bold text-gray-800 mb-6">Agendar Cita</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Paciente:
                                    </label>
                                    <input
                                        type="text"
                                        name="paciente"
                                        value={formData.paciente}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Tipo de cita:
                                    </label>
                                    <select
                                        name="tipo"
                                        value={formData.tipo}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="presencial">Presencial</option>
                                        <option value="videoconsulta">Videoconsulta (Google Meet)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Fecha:
                                    </label>
                                    <input
                                        type="date"
                                        name="fecha"
                                        value={formData.fecha}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Hora:
                                    </label>
                                    <input
                                        type="time"
                                        name="hora"
                                        value={formData.hora}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Motivo:
                                </label>
                                <textarea
                                    name="motivo"
                                    value={formData.motivo}
                                    onChange={handleChange}
                                    rows="3"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
                            >
                                📅 Agendar Cita
                            </button>
                        </form>
                    </div>

                    {/* Lista de citas */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h4 className="text-xl font-bold text-gray-800 mb-4">Citas Programadas</h4>
                        <div className="space-y-3">
                            {citas.map((cita, index) => (
                                <div key={index} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h5 className="font-semibold text-gray-800">{cita.paciente}</h5>
                                            <p className="text-sm text-gray-600">
                                                {cita.fecha} a las {cita.hora}
                                            </p>
                                            <p className="text-sm text-gray-600">{cita.motivo}</p>
                                            <span className={`inline-block px-2 py-1 rounded-full text-xs font-semibold mt-2 ${
                                                cita.tipo === 'videoconsulta' 
                                                    ? 'bg-blue-100 text-blue-800' 
                                                    : 'bg-green-100 text-green-800'
                                            }`}>
                                                {cita.tipo === 'videoconsulta' ? '📹 Videoconsulta' : '🏥 Presencial'}
                                            </span>
                                        </div>
                                        {cita.tipo === 'videoconsulta' && (
                                            <button
                                                onClick={() => window.open(generateMeetLink(cita), '_blank')}
                                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition duration-300"
                                            >
                                                🚀 Iniciar Meet
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Componente principal
        const MedicalApp = () => {
            const { user, login, logout, loading } = useAuth();
            const { historias, formulas, citas, saveHistoria, saveFormula, saveCita } = useMedicalData();
            const [activeTab, setActiveTab] = useState('dashboard');

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <LoginForm onLogin={login} />;
            }

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: '📊' },
                { id: 'historia', label: 'Historia Clínica', icon: '📋' },
                { id: 'formula', label: 'Fórmula Médica', icon: '💊' },
                { id: 'busqueda', label: 'Buscar Paciente', icon: '🔍' },
                { id: 'agenda', label: 'Agenda', icon: '📅' }
            ];

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <h1 className="text-2xl font-bold text-gray-900">
                                    Sistema Médico - Historia Clínica
                                </h1>
                                <div className="flex items-center space-x-4">
                                    <span className="text-gray-700">
                                        Bienvenido, {user.name}
                                    </span>
                                    <button
                                        onClick={logout}
                                        className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-300"
                                    >
                                        Cerrar Sesión
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                            {/* Sidebar */}
                            <div className="lg:col-span-1">
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <nav className="space-y-2">
                                        {menuItems.map((item) => (
                                            <button
                                                key={item.id}
                                                onClick={() => setActiveTab(item.id)}
                                                className={`w-full text-left px-4 py-3 rounded-lg transition duration-300 ${
                                                    activeTab === item.id
                                                        ? 'bg-blue-600 text-white'
                                                        : 'text-gray-700 hover:bg-gray-100'
                                                }`}
                                            >
                                                <span className="mr-3">{item.icon}</span>
                                                {item.label}
                                            </button>
                                        ))}
                                    </nav>
                                </div>
                            </div>

                            {/* Main Content */}
                            <div className="lg:col-span-3">
                                {activeTab === 'dashboard' && (
                                    <Dashboard historias={historias} formulas={formulas} citas={citas} />
                                )}
                                {activeTab === 'historia' && (
                                    <HistoriaClinicaForm onSave={saveHistoria} />
                                )}
                                {activeTab === 'formula' && (
                                    <FormulaMedicaForm onSave={saveFormula} />
                                )}
                                {activeTab === 'busqueda' && (
                                    <BusquedaPacientes historias={historias} formulas={formulas} />
                                )}
                                {activeTab === 'agenda' && (
                                    <Agenda citas={citas} onSaveCita={saveCita} />
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Renderizar la aplicación
        const root = createRoot(document.getElementById('app'));
        root.render(<MedicalApp />);
    </script>
</body>
</html>