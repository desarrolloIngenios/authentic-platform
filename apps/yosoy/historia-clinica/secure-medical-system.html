<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YoSoy Historia Cl√≠nica - Sistema M√©dico Digital</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html2canvas@latest/dist/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .medical-form { background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); }
        .form-section { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .medical-card { transition: all 0.3s ease; }
        .medical-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(147, 51, 234, 0.1); }
        .stat-card { background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%); }
        .search-highlight { background-color: #c084fc; }
        .yosoy-purple { color: #9333ea; }
        .yosoy-bg-purple { background-color: #9333ea; }
        .yosoy-bg-light-purple { background-color: #f3e8ff; }
        .yosoy-border-purple { border-color: #9333ea; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // Utilidades de seguridad
        const SecurityUtils = {
            encrypt: (data) => {
                try {
                    return btoa(JSON.stringify(data));
                } catch (e) {
                    console.error('Error al encriptar:', e);
                    return null;
                }
            },
            decrypt: (encryptedData) => {
                try {
                    return JSON.parse(atob(encryptedData));
                } catch (e) {
                    console.error('Error al desencriptar:', e);
                    return null;
                }
            },
            hashPassword: (password) => {
                return btoa(password + 'salt_secure_2024');
            },
            generateSessionToken: () => {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
        };

        // Sistema de auditoria simplificado
        const AuditSystem = {
            log: (action, userId, details) => {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    action,
                    userId,
                    details,
                    sessionId: sessionStorage.getItem('sessionId')
                };
                
                const existingLogs = SecurityUtils.decrypt(localStorage.getItem('auditLogs')) || [];
                existingLogs.push(logEntry);
                localStorage.setItem('auditLogs', SecurityUtils.encrypt(existingLogs));
            }
        };

        // Configuraci√≥n de API
        const API_CONFIG = {
            baseURL: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                ? 'http://localhost:3001/api' 
                : 'https://api.hc.yo-soy.co/api',
            timeout: 10000,
            headers: {
                'Content-Type': 'application/json'
            }
        };

        // Utilidad para hacer peticiones HTTP
        const httpClient = {
            async request(endpoint, options = {}) {
                const url = `${API_CONFIG.baseURL}${endpoint}`;
                const token = sessionStorage.getItem('authToken');
                
                const config = {
                    ...options,
                    headers: {
                        ...API_CONFIG.headers,
                        ...(token && { Authorization: `Bearer ${token}` }),
                        ...options.headers
                    }
                };

                try {
                    const response = await fetch(url, config);
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: 'Error de red' }));
                        throw new Error(error.error || `HTTP ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            },

            get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            },

            post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            },

            put(endpoint, data) {
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
            },

            delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            }
        };

        // Usuarios del sistema
        const SYSTEM_USERS = [
            {
                id: 1,
                username: 'admin',
                password: SecurityUtils.hashPassword('admin123'),
                role: 'administrador',
                name: 'Dr. Admin',
                email: 'admin@clinica.com',
                permissions: ['all']
            },
            {
                id: 2,
                username: 'doctor',
                password: SecurityUtils.hashPassword('doctor123'),
                role: 'doctor',
                name: 'Dr. Garc√≠a',
                email: 'doctor@clinica.com',
                permissions: ['read_patients', 'write_patients', 'create_prescriptions']
            },
            {
                id: 3,
                username: 'anamaria',
                password: SecurityUtils.hashPassword('anamaria2025'),
                role: 'doctor',
                name: 'Dra. Ana Mar√≠a Rodr√≠guez',
                email: 'anamariar@yo-soy.co',
                especialidad: 'Medicina General y Salud Femenina',
                registro: 'RM-58421',
                telefono: '+57 310 643 3823',
                permissions: ['read_patients', 'write_patients', 'create_prescriptions', 'telehealth']
            }
        ];

        // Hook de autenticaci√≥n actualizado
        const useAuth = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            useEffect(() => {
                const sessionToken = sessionStorage.getItem('authToken');
                const encryptedUser = sessionStorage.getItem('currentUser');
                
                if (sessionToken && encryptedUser) {
                    const userData = SecurityUtils.decrypt(encryptedUser);
                    if (userData) {
                        setUser(userData);
                        AuditSystem.log('SESSION_RESTORED', userData.id, { username: userData.username });
                    }
                }
                setLoading(false);
            }, []);

            const login = async (username, password) => {
                try {
                    setLoading(true);
                    
                    if (isOnline) {
                        // Intentar login con API
                        try {
                            const response = await httpClient.post('/auth/login', { username, password });
                            
                            const userData = {
                                id: response.user.id,
                                username: response.user.username,
                                name: response.user.nombre,
                                role: response.user.rol === 'admin' ? 'administrador' : response.user.rol,
                                email: response.user.email,
                                especialidad: response.user.especialidad
                            };

                            sessionStorage.setItem('authToken', response.token);
                            sessionStorage.setItem('currentUser', SecurityUtils.encrypt(userData));
                            sessionStorage.setItem('sessionId', `session_${userData.id}_${Date.now()}`);
                            
                            setUser(userData);
                            AuditSystem.log('LOGIN_SUCCESS_API', userData.id, { username: userData.username });
                            
                            setLoading(false);
                            return true;
                        } catch (apiError) {
                            console.warn('API login failed, falling back to local auth:', apiError);
                            // Fallback a autenticaci√≥n local
                        }
                    }

                    // Autenticaci√≥n local (fallback)
                    const user = SYSTEM_USERS.find(u => 
                        u.username === username && u.password === SecurityUtils.hashPassword(password)
                    );
                    
                    if (user) {
                        const sessionToken = SecurityUtils.generateSessionToken();
                        const userSession = { ...user };
                        delete userSession.password;
                        
                        sessionStorage.setItem('sessionToken', sessionToken);
                        sessionStorage.setItem('sessionId', sessionToken);
                        sessionStorage.setItem('currentUser', SecurityUtils.encrypt(userSession));
                        
                        setUser(userSession);
                        AuditSystem.log('LOGIN_SUCCESS_LOCAL', user.id, { username: user.username });
                        setLoading(false);
                        return true;
                    }
                    
                    setLoading(false);
                    AuditSystem.log('LOGIN_FAILED', null, { username });
                    return false;
                } catch (error) {
                    setLoading(false);
                    console.error('Login error:', error);
                    return false;
                }
            };

            const logout = () => {
                if (user) {
                    AuditSystem.log('LOGOUT', user.id, { username: user.username });
                }
                sessionStorage.removeItem('authToken');
                sessionStorage.removeItem('sessionToken');
                sessionStorage.removeItem('currentUser');
                sessionStorage.removeItem('sessionId');
                setUser(null);
            };

            return { user, login, logout, loading, isOnline };
        };

        // Hook para datos m√©dicos
        const useMedicalData = () => {
            const [historias, setHistorias] = useState([]);
            const [formulas, setFormulas] = useState([]);
            const [citas, setCitas] = useState([]);

            useEffect(() => {
                const loadedHistorias = SecurityUtils.decrypt(localStorage.getItem('historias_clinicas')) || [];
                const loadedFormulas = SecurityUtils.decrypt(localStorage.getItem('formulas_medicas')) || [];
                const loadedCitas = SecurityUtils.decrypt(localStorage.getItem('citas_medicas')) || [];
                
                setHistorias(loadedHistorias);
                setFormulas(loadedFormulas);
                setCitas(loadedCitas);
            }, []);

            const saveHistoria = (historia) => {
                const newHistoria = {
                    ...historia,
                    id: Date.now(),
                    fechaCreacion: new Date().toISOString(),
                    userId: sessionStorage.getItem('sessionId')
                };
                
                const updatedHistorias = [...historias, newHistoria];
                setHistorias(updatedHistorias);
                localStorage.setItem('historias_clinicas', SecurityUtils.encrypt(updatedHistorias));
                
                AuditSystem.log('HISTORIA_CREATED', newHistoria.userId, { 
                    paciente: newHistoria.nombrePaciente,
                    historiaId: newHistoria.id 
                });
            };

            const saveFormula = (formula) => {
                const newFormula = {
                    ...formula,
                    id: Date.now(),
                    fechaCreacion: new Date().toISOString(),
                    userId: sessionStorage.getItem('sessionId')
                };
                
                const updatedFormulas = [...formulas, newFormula];
                setFormulas(updatedFormulas);
                localStorage.setItem('formulas_medicas', SecurityUtils.encrypt(updatedFormulas));
                
                AuditSystem.log('FORMULA_CREATED', newFormula.userId, { 
                    paciente: newFormula.nombrePaciente,
                    formulaId: newFormula.id 
                });
            };

            const saveCita = (cita) => {
                const newCita = {
                    ...cita,
                    id: Date.now(),
                    fechaCreacion: new Date().toISOString(),
                    userId: sessionStorage.getItem('sessionId')
                };
                
                const updatedCitas = [...citas, newCita];
                setCitas(updatedCitas);
                localStorage.setItem('citas_medicas', SecurityUtils.encrypt(updatedCitas));
                
                AuditSystem.log('CITA_CREATED', newCita.userId, { 
                    paciente: newCita.paciente,
                    citaId: newCita.id 
                });
            };

            return {
                historias,
                formulas,
                citas,
                saveHistoria,
                saveFormula,
                saveCita
            };
        };

        // Funciones para videoconsultas avanzadas
        const generateAdvancedMeetLink = (cita) => {
            // Genera un enlace de Google Meet √∫nico para la cita
            const meetId = `hc-${cita.id || Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            return `https://meet.google.com/${meetId}`;
        };

        const generateMeetLink = (cita) => {
            return generateAdvancedMeetLink(cita);
        };

        const initiateVideoCall = async (cita) => {
            try {
                const meetLink = generateAdvancedMeetLink(cita);
                
                // Simular notificaci√≥n al paciente
                if (cita.notificarPaciente) {
                    await sendMeetInvitation(cita, meetLink);
                }
                
                // Abrir la videollamada
                window.open(meetLink, '_blank');
                
                // Log de auditor√≠a
                AuditSystem.log('VIDEOCALL_INITIATED', sessionStorage.getItem('sessionId'), { 
                    paciente: cita.paciente,
                    citaId: cita.id,
                    meetLink 
                });
                
                return meetLink;
            } catch (error) {
                console.error('Error al iniciar videollamada:', error);
                alert('Error al iniciar la videollamada. Por favor, int√©ntelo de nuevo.');
                return null;
            }
        };

        const sendMeetInvitation = async (cita, meetLink) => {
            try {
                // Simular env√≠o de invitaci√≥n por email
                const invitation = {
                    to: cita.emailPaciente || `${cita.paciente.toLowerCase().replace(/\s+/g, '')}@email.com`,
                    subject: `Videoconsulta programada - ${cita.fecha}`,
                    body: `
                        Estimado/a ${cita.paciente},
                        
                        Su videoconsulta ha sido programada para:
                        üìÖ Fecha: ${cita.fecha}
                        üïí Hora: ${cita.hora}
                        ‚è±Ô∏è Duraci√≥n: ${cita.duracion} minutos
                        
                        Enlace de la videollamada: ${meetLink}
                        
                        ${cita.notas ? `Notas: ${cita.notas}` : ''}
                        
                        Por favor, √∫nase a la videollamada 5 minutos antes de la hora programada.
                        
                        Saludos cordiales,
                        YoSoy - Sistema de Historias Cl√≠nicas
                    `
                };
                
                console.log('Invitaci√≥n enviada:', invitation);
                
                // En un sistema real, aqu√≠ se enviar√≠a el email
                alert(`Invitaci√≥n enviada exitosamente a ${invitation.to}`);
                
                return true;
            } catch (error) {
                console.error('Error al enviar invitaci√≥n:', error);
                return false;
            }
        };

        // Componente de login
        const LoginForm = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (onLogin(username, password)) {
                    setError('');
                } else {
                    setError('Credenciales inv√°lidas');
                }
            };

            return (
                <div className="min-h-screen medical-form flex items-center justify-center p-4">
                    <div className="form-section border border-white/20 rounded-xl p-8 w-full max-w-md">
                        <h2 className="text-white text-2xl font-bold mb-6 text-center">
                            Sistema M√©dico - Historia Cl√≠nica
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input
                                    type="text"
                                    placeholder="Usuario"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/70"
                                    required
                                />
                            </div>
                            <div>
                                <input
                                    type="password"
                                    placeholder="Contrase√±a"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/70"
                                    required
                                />
                            </div>
                            {error && (
                                <div className="text-red-300 text-sm text-center">{error}</div>
                            )}
                            <button
                                type="submit"
                                className="w-full bg-white/20 hover:bg-white/30 text-white font-bold py-3 px-4 rounded-lg transition duration-300"
                            >
                                Iniciar Sesi√≥n
                            </button>
                        </form>
                        <div className="mt-4 text-white/70 text-sm text-center">
                            <p>Usuarios de prueba:</p>
                            <p>admin / admin123</p>
                            <p>doctor / doctor123</p>
                        </div>
                    </div>
                </div>
            );
        };

        // Formulario de Historia Cl√≠nica
        const HistoriaClinicaForm = ({ onSave }) => {
            const [formData, setFormData] = useState({
                nombrePaciente: '',
                fechaNacimiento: '',
                edad: '',
                motivoConsulta: '',
                antecedentes: '',
                examenFisico: '',
                diagnostico: '',
                analisis: '',
                planManejo: ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));

                // Calcular edad autom√°ticamente
                if (name === 'fechaNacimiento' && value) {
                    const today = new Date();
                    const birthDate = new Date(value);
                    const age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    
                    setFormData(prev => ({
                        ...prev,
                        edad: age.toString()
                    }));
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
                setFormData({
                    nombrePaciente: '',
                    fechaNacimiento: '',
                    edad: '',
                    motivoConsulta: '',
                    antecedentes: '',
                    examenFisico: '',
                    diagnostico: '',
                    analisis: '',
                    planManejo: ''
                });
                alert('Historia cl√≠nica guardada exitosamente');
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-2xl font-bold text-gray-800 mb-6">Historia Cl√≠nica</h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Nombre del paciente:
                                </label>
                                <input
                                    type="text"
                                    name="nombrePaciente"
                                    value={formData.nombrePaciente}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Fecha de nacimiento:
                                </label>
                                <input
                                    type="date"
                                    name="fechaNacimiento"
                                    value={formData.fechaNacimiento}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Edad:
                                </label>
                                <input
                                    type="number"
                                    name="edad"
                                    value={formData.edad}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    required
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Motivo de consulta:
                            </label>
                            <textarea
                                name="motivoConsulta"
                                value={formData.motivoConsulta}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Antecedentes:
                            </label>
                            <textarea
                                name="antecedentes"
                                value={formData.antecedentes}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Examen f√≠sico:
                            </label>
                            <textarea
                                name="examenFisico"
                                value={formData.examenFisico}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Diagn√≥stico:
                            </label>
                            <textarea
                                name="diagnostico"
                                value={formData.diagnostico}
                                onChange={handleChange}
                                rows="2"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                An√°lisis:
                            </label>
                            <textarea
                                name="analisis"
                                value={formData.analisis}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                required
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Plan de manejo:
                            </label>
                            <textarea
                                name="planManejo"
                                value={formData.planManejo}
                                onChange={handleChange}
                                rows="3"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                required
                            />
                        </div>

                        <button
                            type="submit"
                            className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
                        >
                            üîí Guardar Historia Cl√≠nica
                        </button>
                    </form>
                </div>
            );
        };

        // Formulario de F√≥rmula M√©dica Mejorado
        const FormulaMedicaForm = ({ onSave, currentUser }) => {
            const [formData, setFormData] = useState({
                nombrePaciente: '',
                cedula: '',
                edad: '',
                fecha: new Date().toISOString().split('T')[0],
                medicamentos: '',
                indicaciones: '',
                diagnostico: '',
                recomendaciones: '',
                proximaConsulta: ''
            });

            const [medicamentosList, setMedicamentosList] = useState([
                { nombre: '', dosis: '', frecuencia: '', duracion: '', indicaciones: '' }
            ]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const handleMedicamentoChange = (index, field, value) => {
                const updatedMedicamentos = [...medicamentosList];
                updatedMedicamentos[index][field] = value;
                setMedicamentosList(updatedMedicamentos);
            };

            const addMedicamento = () => {
                setMedicamentosList([...medicamentosList, 
                    { nombre: '', dosis: '', frecuencia: '', duracion: '', indicaciones: '' }
                ]);
            };

            const removeMedicamento = (index) => {
                if (medicamentosList.length > 1) {
                    const updatedMedicamentos = medicamentosList.filter((_, i) => i !== index);
                    setMedicamentosList(updatedMedicamentos);
                }
            };

            const generateProfessionalPDF = (formulaData, doctorInfo) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header con logo YoSoy
                doc.setFillColor(147, 51, 234);
                doc.rect(0, 0, 210, 30, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.text('YoSoy Historia Cl√≠nica', 20, 20);
                
                doc.setFontSize(12);
                doc.text('Sistema M√©dico Digital', 150, 20);

                // Informaci√≥n del doctor actual
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.text(`${doctorInfo.name} - ${doctorInfo.especialidad || 'Medicina General'}`, 20, 45);
                doc.setFontSize(10);
                doc.text(`Registro M√©dico: ${doctorInfo.registro || 'RM-12345'}`, 20, 52);
                doc.text(`${doctorInfo.email} | ${doctorInfo.telefono || 'hc.yo-soy.co'}`, 20, 58);

                // T√≠tulo de prescripci√≥n
                doc.setFontSize(18);
                doc.setTextColor(147, 51, 234);
                doc.text('PRESCRIPCI√ìN M√âDICA', 20, 75);

                // Informaci√≥n del paciente
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.text('DATOS DEL PACIENTE:', 20, 90);
                doc.setFontSize(10);
                doc.text(`Nombre: ${formulaData.nombrePaciente}`, 20, 100);
                doc.text(`C√©dula: ${formulaData.cedula || 'No especificada'}`, 20, 107);
                doc.text(`Edad: ${formulaData.edad || 'No especificada'}`, 20, 114);
                doc.text(`Fecha: ${new Date(formulaData.fecha).toLocaleDateString()}`, 120, 100);
                doc.text(`Diagn√≥stico: ${formulaData.diagnostico || 'No especificado'}`, 20, 121);

                // L√≠nea separadora
                doc.setDrawColor(147, 51, 234);
                doc.line(20, 130, 190, 130);

                // Medicamentos
                doc.setFontSize(12);
                doc.setTextColor(147, 51, 234);
                doc.text('MEDICAMENTOS PRESCRITOS:', 20, 145);

                let yPosition = 155;
                medicamentosList.forEach((med, index) => {
                    if (med.nombre.trim()) {
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(11);
                        doc.text(`${index + 1}. ${med.nombre}`, 25, yPosition);
                        yPosition += 7;
                        
                        if (med.dosis) {
                            doc.setFontSize(9);
                            doc.text(`   Dosis: ${med.dosis}`, 25, yPosition);
                            yPosition += 6;
                        }
                        
                        if (med.frecuencia) {
                            doc.text(`   Frecuencia: ${med.frecuencia}`, 25, yPosition);
                            yPosition += 6;
                        }
                        
                        if (med.duracion) {
                            doc.text(`   Duraci√≥n: ${med.duracion}`, 25, yPosition);
                            yPosition += 6;
                        }
                        
                        if (med.indicaciones) {
                            doc.text(`   Indicaciones: ${med.indicaciones}`, 25, yPosition);
                            yPosition += 6;
                        }
                        
                        yPosition += 3;
                    }
                });

                // Recomendaciones
                if (formulaData.recomendaciones) {
                    doc.setFontSize(12);
                    doc.setTextColor(147, 51, 234);
                    doc.text('RECOMENDACIONES:', 20, yPosition + 10);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(10);
                    const recomendacionesLines = doc.splitTextToSize(formulaData.recomendaciones, 170);
                    doc.text(recomendacionesLines, 20, yPosition + 20);
                    yPosition += 20 + (recomendacionesLines.length * 5);
                }

                // Pr√≥xima consulta
                if (formulaData.proximaConsulta) {
                    doc.setFontSize(10);
                    doc.text(`Pr√≥xima consulta: ${formulaData.proximaConsulta}`, 20, yPosition + 15);
                }

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text('Este documento fue generado digitalmente por YoSoy Historia Cl√≠nica', 20, 280);
                doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleString()}`, 20, 285);

                // Firma digital
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('_________________________', 120, 250);
                doc.text(doctorInfo.name, 120, 260);
                doc.text(doctorInfo.especialidad || 'Medicina General', 120, 265);

                doc.save(`prescripcion-${formulaData.nombrePaciente}-${formulaData.fecha}.pdf`);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                // Convertir medicamentos a string
                const medicamentosString = medicamentosList
                    .filter(med => med.nombre.trim())
                    .map(med => `${med.nombre} - ${med.dosis} - ${med.frecuencia} - ${med.duracion}`)
                    .join('; ');

                const formulaCompleta = {
                    ...formData,
                    medicamentos: medicamentosString,
                    medicamentosList: medicamentosList
                };

                onSave(formulaCompleta);
                generateProfessionalPDF(formulaCompleta, currentUser);
                
                setFormData({
                    nombrePaciente: '',
                    cedula: '',
                    edad: '',
                    fecha: new Date().toISOString().split('T')[0],
                    medicamentos: '',
                    indicaciones: '',
                    diagnostico: '',
                    recomendaciones: '',
                    proximaConsulta: ''
                });
                
                setMedicamentosList([
                    { nombre: '', dosis: '', frecuencia: '', duracion: '', indicaciones: '' }
                ]);
                
                alert('F√≥rmula m√©dica guardada y PDF generado exitosamente');
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-2xl font-bold text-purple-800 mb-6">üíä Prescripci√≥n M√©dica Profesional</h3>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        {/* Informaci√≥n del paciente */}
                        <div className="bg-purple-50 p-4 rounded-lg">
                            <h4 className="text-lg font-semibold text-purple-800 mb-3">Datos del Paciente</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Nombre completo:
                                    </label>
                                    <input
                                        type="text"
                                        name="nombrePaciente"
                                        value={formData.nombrePaciente}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        C√©dula:
                                    </label>
                                    <input
                                        type="text"
                                        name="cedula"
                                        value={formData.cedula}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Edad:
                                    </label>
                                    <input
                                        type="number"
                                        name="edad"
                                        value={formData.edad}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Informaci√≥n m√©dica */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Fecha:
                                </label>
                                <input
                                    type="date"
                                    name="fecha"
                                    value={formData.fecha}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Pr√≥xima consulta:
                                </label>
                                <input
                                    type="date"
                                    name="proximaConsulta"
                                    value={formData.proximaConsulta}
                                    onChange={handleChange}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                />
                            </div>
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Diagn√≥stico:
                            </label>
                            <input
                                type="text"
                                name="diagnostico"
                                value={formData.diagnostico}
                                onChange={handleChange}
                                placeholder="Diagn√≥stico principal"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            />
                        </div>

                        {/* Medicamentos */}
                        <div className="bg-gray-50 p-4 rounded-lg">
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="text-lg font-semibold text-gray-800">Medicamentos</h4>
                                <button
                                    type="button"
                                    onClick={addMedicamento}
                                    className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition duration-300"
                                >
                                    + Agregar medicamento
                                </button>
                            </div>
                            
                            {medicamentosList.map((medicamento, index) => (
                                <div key={index} className="bg-white p-4 rounded-lg mb-3 border">
                                    <div className="flex justify-between items-center mb-3">
                                        <h5 className="font-medium text-gray-700">Medicamento {index + 1}</h5>
                                        {medicamentosList.length > 1 && (
                                            <button
                                                type="button"
                                                onClick={() => removeMedicamento(index)}
                                                className="text-red-600 hover:text-red-800 text-sm"
                                            >
                                                ‚úï Eliminar
                                            </button>
                                        )}
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Nombre del medicamento:</label>
                                            <input
                                                type="text"
                                                value={medicamento.nombre}
                                                onChange={(e) => handleMedicamentoChange(index, 'nombre', e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 text-sm"
                                                placeholder="Ej: Acetaminof√©n"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Dosis:</label>
                                            <input
                                                type="text"
                                                value={medicamento.dosis}
                                                onChange={(e) => handleMedicamentoChange(index, 'dosis', e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 text-sm"
                                                placeholder="Ej: 500mg"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Frecuencia:</label>
                                            <input
                                                type="text"
                                                value={medicamento.frecuencia}
                                                onChange={(e) => handleMedicamentoChange(index, 'frecuencia', e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 text-sm"
                                                placeholder="Ej: Cada 8 horas"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Duraci√≥n:</label>
                                            <input
                                                type="text"
                                                value={medicamento.duracion}
                                                onChange={(e) => handleMedicamentoChange(index, 'duracion', e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 text-sm"
                                                placeholder="Ej: 7 d√≠as"
                                            />
                                        </div>
                                        <div className="md:col-span-2">
                                            <label className="block text-xs text-gray-600 mb-1">Indicaciones especiales:</label>
                                            <input
                                                type="text"
                                                value={medicamento.indicaciones}
                                                onChange={(e) => handleMedicamentoChange(index, 'indicaciones', e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded focus:ring-1 focus:ring-purple-500 text-sm"
                                                placeholder="Ej: Tomar con alimentos"
                                            />
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Indicaciones generales:
                            </label>
                            <textarea
                                name="indicaciones"
                                value={formData.indicaciones}
                                onChange={handleChange}
                                rows="3"
                                placeholder="Instrucciones generales para el paciente..."
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            />
                        </div>

                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Recomendaciones adicionales:
                            </label>
                            <textarea
                                name="recomendaciones"
                                value={formData.recomendaciones}
                                onChange={handleChange}
                                rows="3"
                                placeholder="Recomendaciones de cuidado, dieta, ejercicio, etc..."
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            />
                        </div>

                        <button
                            type="submit"
                            className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center"
                        >
                            üìÑ Generar Prescripci√≥n y PDF
                        </button>
                    </form>
                </div>
            );
        };

        // Componente de Agenda/Citas

        // B√∫squeda de Pacientes
        const BusquedaPacientes = ({ historias, formulas }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [searchResults, setSearchResults] = useState([]);

            const handleSearch = () => {
                if (!searchTerm.trim()) {
                    setSearchResults([]);
                    return;
                }

                // Buscar en historias cl√≠nicas
                const historiasEncontradas = historias.filter(h => 
                    h.nombrePaciente.toLowerCase().includes(searchTerm.toLowerCase())
                );

                // Buscar en f√≥rmulas
                const formulasEncontradas = formulas.filter(f => 
                    f.nombrePaciente.toLowerCase().includes(searchTerm.toLowerCase())
                );

                // Crear un mapa de pacientes √∫nicos
                const pacientesMap = new Map();

                historiasEncontradas.forEach(h => {
                    if (!pacientesMap.has(h.nombrePaciente)) {
                        pacientesMap.set(h.nombrePaciente, {
                            nombre: h.nombrePaciente,
                            historias: [],
                            formulas: []
                        });
                    }
                    pacientesMap.get(h.nombrePaciente).historias.push(h);
                });

                formulasEncontradas.forEach(f => {
                    if (!pacientesMap.has(f.nombrePaciente)) {
                        pacientesMap.set(f.nombrePaciente, {
                            nombre: f.nombrePaciente,
                            historias: [],
                            formulas: []
                        });
                    }
                    pacientesMap.get(f.nombrePaciente).formulas.push(f);
                });

                setSearchResults(Array.from(pacientesMap.values()));
            };

            const viewPatientDetails = (patient) => {
                setSelectedPatient(patient);
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-2xl font-bold text-gray-800 mb-6">Buscar Paciente</h3>
                    
                    <div className="flex gap-4 mb-6">
                        <input
                            type="text"
                            placeholder="Nombre del paciente..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        />
                        <button
                            onClick={handleSearch}
                            className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition duration-300"
                        >
                            üîç Buscar
                        </button>
                    </div>

                    {searchResults.length > 0 && (
                        <div className="space-y-4">
                            <h4 className="text-lg font-semibold text-gray-700">Resultados:</h4>
                            {searchResults.map((patient, index) => (
                                <div key={index} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h5 className="font-semibold text-gray-800">{patient.nombre}</h5>
                                            <p className="text-sm text-gray-600">
                                                {patient.historias.length} historias cl√≠nicas ‚Ä¢ {patient.formulas.length} f√≥rmulas m√©dicas
                                            </p>
                                        </div>
                                        <button
                                            onClick={() => viewPatientDetails(patient)}
                                            className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm transition duration-300"
                                        >
                                            Ver Detalles
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {selectedPatient && (
                        <div className="mt-8 border-t pt-6">
                            <div className="flex justify-between items-center mb-4">
                                <h4 className="text-xl font-bold text-gray-800">
                                    Historial M√©dico: {selectedPatient.nombre}
                                </h4>
                                <button
                                    onClick={() => setSelectedPatient(null)}
                                    className="text-gray-500 hover:text-gray-700"
                                >
                                    ‚úï Cerrar
                                </button>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <h5 className="font-semibold text-gray-700 mb-3">Historias Cl√≠nicas ({selectedPatient.historias.length})</h5>
                                    <div className="space-y-3 max-h-60 overflow-y-auto">
                                        {selectedPatient.historias.map((historia, index) => (
                                            <div key={index} className="bg-purple-50 p-3 rounded-lg">
                                                <p className="text-sm text-gray-600 mb-1">
                                                    {new Date(historia.fechaCreacion).toLocaleDateString()}
                                                </p>
                                                <p className="font-medium text-gray-800">
                                                    {historia.diagnostico}
                                                </p>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    Motivo: {historia.motivoConsulta}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <h5 className="font-semibold text-gray-700 mb-3">F√≥rmulas M√©dicas ({selectedPatient.formulas.length})</h5>
                                    <div className="space-y-3 max-h-60 overflow-y-auto">
                                        {selectedPatient.formulas.map((formula, index) => (
                                            <div key={index} className="bg-green-50 p-3 rounded-lg">
                                                <p className="text-sm text-gray-600 mb-1">
                                                    {new Date(formula.fechaCreacion).toLocaleDateString()}
                                                </p>
                                                <p className="font-medium text-gray-800">
                                                    {formula.medicamentos}
                                                </p>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    {formula.indicaciones}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Dashboard con Estad√≠sticas Avanzadas
        const Dashboard = ({ historias, formulas, citas }) => {
            const [stats, setStats] = useState({
                totalPacientes: 0,
                totalHistorias: 0,
                totalFormulas: 0,
                totalCitas: 0,
                topDiagnosticos: [],
                topMedicamentos: [],
                edadPromedio: 0,
                tendenciaMensual: [],
                distribucionGenero: { masculino: 0, femenino: 0, otro: 0 },
                rangoEdades: { jovenes: 0, adultos: 0, mayores: 0 },
                factorRiesgo: 'bajo',
                indicadorCalidad: 85
            });

            const [selectedMetric, setSelectedMetric] = useState('consultas');
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                // Calcular estad√≠sticas avanzadas
                const pacientesUnicos = new Set();
                const diagnosticos = {};
                const medicamentos = {};
                const consultas_por_mes = {};
                const generos = { masculino: 0, femenino: 0, otro: 0 };
                const edades = { jovenes: 0, adultos: 0, mayores: 0 };
                
                let totalEdad = 0;
                let pacientesConEdad = 0;

                historias.forEach(h => {
                    pacientesUnicos.add(h.nombrePaciente);
                    
                    if (h.diagnostico) {
                        diagnosticos[h.diagnostico] = (diagnosticos[h.diagnostico] || 0) + 1;
                    }
                    
                    if (h.edad) {
                        const edad = parseInt(h.edad);
                        totalEdad += edad;
                        pacientesConEdad++;
                        
                        if (edad < 30) edades.jovenes++;
                        else if (edad < 60) edades.adultos++;
                        else edades.mayores++;
                    }

                    // Simulaci√≥n de g√©nero (para demostraci√≥n)
                    const genero = Math.random() > 0.5 ? 'femenino' : 'masculino';
                    generos[genero]++;

                    // Tendencia mensual
                    const fecha = new Date(h.fecha || Date.now());
                    const mesAno = `${fecha.getFullYear()}-${(fecha.getMonth() + 1).toString().padStart(2, '0')}`;
                    consultas_por_mes[mesAno] = (consultas_por_mes[mesAno] || 0) + 1;
                });

                formulas.forEach(f => {
                    pacientesUnicos.add(f.nombrePaciente);
                    
                    if (f.medicamentos) {
                        const meds = f.medicamentos.split(',');
                        meds.forEach(med => {
                            const medName = med.trim().split(' ')[0];
                            if (medName) {
                                medicamentos[medName] = (medicamentos[medName] || 0) + 1;
                            }
                        });
                    }
                });

                const topDiagnosticos = Object.entries(diagnosticos)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([diag, count]) => ({ name: diag, count }));

                const topMedicamentos = Object.entries(medicamentos)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([med, count]) => ({ name: med, count }));

                // Tendencia mensual (√∫ltimos 6 meses)
                const tendenciaMensual = Object.entries(consultas_por_mes)
                    .sort(([a], [b]) => a.localeCompare(b))
                    .slice(-6)
                    .map(([mes, count]) => ({ mes, count }));

                // Calcular factor de riesgo basado en datos
                const avgConsultasPorPaciente = pacientesUnicos.size > 0 ? historias.length / pacientesUnicos.size : 0;
                const factorRiesgo = avgConsultasPorPaciente > 3 ? 'alto' : avgConsultasPorPaciente > 1.5 ? 'medio' : 'bajo';

                setStats({
                    totalPacientes: pacientesUnicos.size,
                    totalHistorias: historias.length,
                    totalFormulas: formulas.length,
                    totalCitas: citas.length,
                    topDiagnosticos,
                    topMedicamentos,
                    edadPromedio: pacientesConEdad > 0 ? Math.round(totalEdad / pacientesConEdad) : 0,
                    tendenciaMensual,
                    distribucionGenero: generos,
                    rangoEdades: edades,
                    factorRiesgo,
                    indicadorCalidad: Math.min(95, 70 + (pacientesUnicos.size * 2))
                });
            }, [historias, formulas, citas]);

            // Crear/actualizar gr√°fico
            useEffect(() => {
                if (chartRef.current && stats.tendenciaMensual.length > 0) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: stats.tendenciaMensual.map(item => item.mes),
                            datasets: [{
                                label: 'Consultas por Mes',
                                data: stats.tendenciaMensual.map(item => item.count),
                                borderColor: '#9333ea',
                                backgroundColor: 'rgba(147, 51, 234, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [stats.tendenciaMensual, selectedMetric]);

            const exportarReporte = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text('Reporte Anal√≠tico - YoSoy Historia Cl√≠nica', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleDateString()}`, 20, 35);
                
                doc.text('M√âTRICAS PRINCIPALES:', 20, 50);
                doc.text(`‚Ä¢ Total de Pacientes: ${stats.totalPacientes}`, 25, 60);
                doc.text(`‚Ä¢ Historias Cl√≠nicas: ${stats.totalHistorias}`, 25, 70);
                doc.text(`‚Ä¢ F√≥rmulas M√©dicas: ${stats.totalFormulas}`, 25, 80);
                doc.text(`‚Ä¢ Edad Promedio: ${stats.edadPromedio} a√±os`, 25, 90);
                doc.text(`‚Ä¢ Indicador de Calidad: ${stats.indicadorCalidad}%`, 25, 100);
                
                doc.text('DIAGN√ìSTICOS M√ÅS FRECUENTES:', 20, 120);
                stats.topDiagnosticos.forEach((diag, index) => {
                    doc.text(`${index + 1}. ${diag.name}: ${diag.count} casos`, 25, 130 + (index * 10));
                });
                
                doc.save('reporte-analitico-yosoy.pdf');
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h3 className="text-2xl font-bold text-purple-800">Dashboard Anal√≠tico Avanzado</h3>
                        <button
                            onClick={exportarReporte}
                            className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition duration-300 flex items-center"
                        >
                            üìä Exportar Reporte
                        </button>
                    </div>
                    
                    {/* Tarjetas de estad√≠sticas mejoradas */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="stat-card text-white rounded-xl p-6 relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-16 h-16 bg-white bg-opacity-20 rounded-full -mr-8 -mt-8"></div>
                            <h4 className="text-lg font-semibold mb-2">üë• Total Pacientes</h4>
                            <p className="text-3xl font-bold">{stats.totalPacientes}</p>
                            <p className="text-sm opacity-80 mt-1">+{Math.round(stats.totalPacientes * 0.15)} este mes</p>
                        </div>
                        <div className="stat-card text-white rounded-xl p-6 relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-16 h-16 bg-white bg-opacity-20 rounded-full -mr-8 -mt-8"></div>
                            <h4 className="text-lg font-semibold mb-2">üìã Historias Cl√≠nicas</h4>
                            <p className="text-3xl font-bold">{stats.totalHistorias}</p>
                            <p className="text-sm opacity-80 mt-1">Promedio: {stats.totalPacientes > 0 ? (stats.totalHistorias / stats.totalPacientes).toFixed(1) : 0} por paciente</p>
                        </div>
                        <div className="stat-card text-white rounded-xl p-6 relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-16 h-16 bg-white bg-opacity-20 rounded-full -mr-8 -mt-8"></div>
                            <h4 className="text-lg font-semibold mb-2">üíä F√≥rmulas M√©dicas</h4>
                            <p className="text-3xl font-bold">{stats.totalFormulas}</p>
                            <p className="text-sm opacity-80 mt-1">Factor de riesgo: {stats.factorRiesgo}</p>
                        </div>
                        <div className="stat-card text-white rounded-xl p-6 relative overflow-hidden">
                            <div className="absolute top-0 right-0 w-16 h-16 bg-white bg-opacity-20 rounded-full -mr-8 -mt-8"></div>
                            <h4 className="text-lg font-semibold mb-2">‚≠ê Calidad de Atenci√≥n</h4>
                            <p className="text-3xl font-bold">{stats.indicadorCalidad}%</p>
                            <p className="text-sm opacity-80 mt-1">Excelente desempe√±o</p>
                        </div>
                    </div>

                    {/* Gr√°fico de tendencias */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h4 className="text-lg font-bold text-gray-800 mb-4">üìà Tendencia de Consultas</h4>
                        <div className="h-64">
                            <canvas ref={chartRef}></canvas>
                        </div>
                    </div>

                    {/* An√°lisis demogr√°fico */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h4 className="text-lg font-bold text-gray-800 mb-4">üë´ Distribuci√≥n por G√©nero</h4>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-700">Femenino</span>
                                    <div className="flex items-center">
                                        <div className="w-24 h-2 bg-gray-200 rounded-full mr-2">
                                            <div className="h-2 bg-purple-500 rounded-full" style={{width: `${(stats.distribucionGenero.femenino / (stats.distribucionGenero.femenino + stats.distribucionGenero.masculino) * 100) || 0}%`}}></div>
                                        </div>
                                        <span className="text-sm font-semibold">{stats.distribucionGenero.femenino}</span>
                                    </div>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-700">Masculino</span>
                                    <div className="flex items-center">
                                        <div className="w-24 h-2 bg-gray-200 rounded-full mr-2">
                                            <div className="h-2 bg-purple-400 rounded-full" style={{width: `${(stats.distribucionGenero.masculino / (stats.distribucionGenero.femenino + stats.distribucionGenero.masculino) * 100) || 0}%`}}></div>
                                        </div>
                                        <span className="text-sm font-semibold">{stats.distribucionGenero.masculino}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h4 className="text-lg font-bold text-gray-800 mb-4">üéÇ Rangos de Edad</h4>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-700">J√≥venes (18-30)</span>
                                    <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        {stats.rangoEdades.jovenes}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-700">Adultos (31-60)</span>
                                    <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        {stats.rangoEdades.adultos}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-700">Mayores (+60)</span>
                                    <span className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        {stats.rangoEdades.mayores}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h4 className="text-lg font-bold text-gray-800 mb-4">üè• Indicadores de Salud</h4>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex justify-between mb-1">
                                        <span className="text-sm text-gray-700">Calidad de Atenci√≥n</span>
                                        <span className="text-sm font-semibold">{stats.indicadorCalidad}%</span>
                                    </div>
                                    <div className="w-full h-2 bg-gray-200 rounded-full">
                                        <div className="h-2 bg-green-500 rounded-full" style={{width: `${stats.indicadorCalidad}%`}}></div>
                                    </div>
                                </div>
                                <div>
                                    <div className="flex justify-between mb-1">
                                        <span className="text-sm text-gray-700">Eficiencia</span>
                                        <span className="text-sm font-semibold">92%</span>
                                    </div>
                                    <div className="w-full h-2 bg-gray-200 rounded-full">
                                        <div className="h-2 bg-purple-500 rounded-full" style={{width: '92%'}}></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* An√°lisis de diagn√≥sticos y medicamentos */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h4 className="text-lg font-bold text-gray-800 mb-4">üè• Diagn√≥sticos M√°s Frecuentes</h4>
                            <div className="space-y-3">
                                {stats.topDiagnosticos.map((diag, index) => (
                                    <div key={index} className="flex justify-between items-center">
                                        <span className="text-gray-700">{diag.name}</span>
                                        <span className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">
                                            {diag.count}
                                        </span>
                                    </div>
                                ))}
                                {stats.topDiagnosticos.length === 0 && (
                                    <p className="text-gray-500 text-center py-4">No hay datos de diagn√≥sticos disponibles</p>
                                )}
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6">
                            <h4 className="text-lg font-bold text-gray-800 mb-4">üíä Medicamentos M√°s Recetados</h4>
                            <div className="space-y-3">
                                {stats.topMedicamentos.map((med, index) => (
                                    <div key={index} className="flex justify-between items-center">
                                        <span className="text-gray-700">{med.name}</span>
                                        <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                            {med.count}
                                        </span>
                                    </div>
                                ))}
                                {stats.topMedicamentos.length === 0 && (
                                    <p className="text-gray-500 text-center py-4">No hay datos de medicamentos disponibles</p>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Predictor de salud mejorado */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h4 className="text-lg font-bold text-gray-800 mb-4">üîÆ An√°lisis Predictivo de Salud</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg">
                                <h5 className="font-semibold text-purple-800 mb-2">An√°lisis Poblacional</h5>
                                <ul className="list-disc list-inside text-gray-700 space-y-1">
                                    {stats.totalPacientes > 0 && (
                                        <li>Promedio de {(stats.totalHistorias / stats.totalPacientes).toFixed(1)} consultas por paciente</li>
                                    )}
                                    {stats.topDiagnosticos.length > 0 && (
                                        <li>Diagn√≥stico m√°s com√∫n: {stats.topDiagnosticos[0]?.name}</li>
                                    )}
                                    {stats.edadPromedio > 0 && (
                                        <li>Poblaci√≥n principalmente {stats.edadPromedio < 30 ? 'joven' : stats.edadPromedio < 60 ? 'adulta' : 'mayor'} (Promedio: {stats.edadPromedio} a√±os)</li>
                                    )}
                                    <li>Factor de riesgo general: <span className={`font-semibold ${stats.factorRiesgo === 'alto' ? 'text-red-600' : stats.factorRiesgo === 'medio' ? 'text-yellow-600' : 'text-green-600'}`}>{stats.factorRiesgo}</span></li>
                                </ul>
                            </div>
                            <div className="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg">
                                <h5 className="font-semibold text-green-800 mb-2">Recomendaciones</h5>
                                <ul className="list-disc list-inside text-gray-700 space-y-1">
                                    {stats.rangoEdades.mayores > stats.rangoEdades.jovenes && (
                                        <li>Implementar programas preventivos para adultos mayores</li>
                                    )}
                                    {stats.distribucionGenero.femenino > stats.distribucionGenero.masculino && (
                                        <li>Enfoque en salud femenina y programas especializados</li>
                                    )}
                                    {stats.topDiagnosticos.length > 0 && (
                                        <li>Desarrollar protocolos espec√≠ficos para {stats.topDiagnosticos[0]?.name}</li>
                                    )}
                                    <li>Mantener calidad de atenci√≥n actual ({stats.indicadorCalidad}%)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Agenda con videoconsultas mejoradas
        const Agenda = ({ citas, onSaveCita }) => {
            const [formData, setFormData] = useState({
                paciente: '',
                fecha: '',
                hora: '',
                motivo: '',
                tipo: 'presencial',
                duracion: '30',
                recordatorio: '15',
                notas: ''
            });

            const [meetRooms, setMeetRooms] = useState({});
            const [activeCall, setActiveCall] = useState(null);
            const [callStatus, setCallStatus] = useState('idle'); // 'idle', 'connecting', 'connected', 'ended'

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const generateAdvancedMeetLink = (cita) => {
                // Generar un ID m√°s descriptivo y √∫nico
                const cleanPatientName = cita.paciente.replace(/\s+/g, '-').toLowerCase();
                const date = new Date(cita.fecha).toISOString().split('T')[0];
                const time = cita.hora.replace(':', '');
                const meetId = `yosoy-${cleanPatientName}-${date}-${time}`;
                const fullMeetUrl = `https://meet.google.com/${meetId}`;
                
                // Guardar informaci√≥n de la sala
                setMeetRooms(prev => ({
                    ...prev,
                    [cita.id]: {
                        url: fullMeetUrl,
                        meetId: meetId,
                        created: new Date().toISOString(),
                        patient: cita.paciente,
                        duration: cita.duracion || 30
                    }
                }));

                return fullMeetUrl;
            };

            const initiateVideoCall = (cita) => {
                setActiveCall(cita);
                setCallStatus('connecting');
                
                const meetUrl = generateAdvancedMeetLink(cita);
                
                // Abrir Google Meet en nueva ventana
                const meetWindow = window.open(meetUrl, '_blank', 
                    'width=1200,height=800,toolbar=no,menubar=no,location=no,status=no'
                );
                
                setCallStatus('connected');
                
                // Simular seguimiento de la llamada
                setTimeout(() => {
                    if (meetWindow && meetWindow.closed) {
                        setCallStatus('ended');
                        setActiveCall(null);
                    }
                }, 1000);
            };

            const sendMeetInvitation = (cita) => {
                const meetUrl = generateAdvancedMeetLink(cita);
                const subject = `Videoconsulta YoSoy - ${cita.paciente}`;
                const body = `
Estimado/a ${cita.paciente},

Su cita m√©dica virtual ha sido programada para:
üìÖ Fecha: ${cita.fecha}
üïí Hora: ${cita.hora}
üë©‚Äç‚öïÔ∏è Doctor: Dra. Ana Mar√≠a Rodr√≠guez
üíä Motivo: ${cita.motivo}

üé• ENLACE DE VIDEOCONSULTA:
${meetUrl}

üì± INSTRUCCIONES:
1. Haga clic en el enlace 5 minutos antes de la cita
2. Permita el acceso a c√°mara y micr√≥fono
3. Tenga a mano su documento de identidad
4. Prepare una lista de sus s√≠ntomas o preguntas

üìû Soporte t√©cnico: +57 310 643 3823
üìß Email: anamariar@yo-soy.co

Saludos cordiales,
YoSoy Historia Cl√≠nica
                `.trim();

                const mailtoLink = `mailto:${cita.email || ''}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoLink);
            };

            const getCallStatusColor = (status) => {
                switch (status) {
                    case 'connecting': return 'text-yellow-600 bg-yellow-100';
                    case 'connected': return 'text-green-600 bg-green-100';
                    case 'ended': return 'text-gray-600 bg-gray-100';
                    default: return 'text-purple-600 bg-purple-100';
                }
            };

            const getCallStatusText = (status) => {
                switch (status) {
                    case 'connecting': return 'üîÑ Conectando...';
                    case 'connected': return 'üü¢ En llamada';
                    case 'ended': return '‚úÖ Finalizada';
                    default: return '‚è∏Ô∏è Pendiente';
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                
                const newCita = {
                    ...formData,
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    status: 'programada'
                };

                onSaveCita(newCita);
                
                // Si es videoconsulta, generar inmediatamente el enlace
                if (formData.tipo === 'videoconsulta') {
                    generateAdvancedMeetLink(newCita);
                }
                
                setFormData({
                    paciente: '',
                    fecha: '',
                    hora: '',
                    motivo: '',
                    tipo: 'presencial',
                    duracion: '30',
                    recordatorio: '15',
                    notas: ''
                });
                
                alert('Cita agendada exitosamente');
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h3 className="text-2xl font-bold text-gray-800 mb-6">Agendar Cita</h3>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Paciente:
                                    </label>
                                    <input
                                        type="text"
                                        name="paciente"
                                        value={formData.paciente}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Tipo de cita:
                                    </label>
                                    <select
                                        name="tipo"
                                        value={formData.tipo}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    >
                                        <option value="presencial">Presencial</option>
                                        <option value="videoconsulta">Videoconsulta (Google Meet)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Fecha:
                                    </label>
                                    <input
                                        type="date"
                                        name="fecha"
                                        value={formData.fecha}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Hora:
                                    </label>
                                    <input
                                        type="time"
                                        name="hora"
                                        value={formData.hora}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                        required
                                    />
                                </div>
                                {formData.tipo === 'videoconsulta' && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">
                                            Duraci√≥n (minutos):
                                        </label>
                                        <select
                                            name="duracion"
                                            value={formData.duracion}
                                            onChange={handleChange}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                        >
                                            <option value="15">15 minutos</option>
                                            <option value="30">30 minutos</option>
                                            <option value="45">45 minutos</option>
                                            <option value="60">1 hora</option>
                                        </select>
                                    </div>
                                )}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Recordatorio (minutos antes):
                                    </label>
                                    <select
                                        name="recordatorio"
                                        value={formData.recordatorio}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    >
                                        <option value="5">5 minutos</option>
                                        <option value="15">15 minutos</option>
                                        <option value="30">30 minutos</option>
                                        <option value="60">1 hora</option>
                                        <option value="1440">1 d√≠a</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Motivo:
                                </label>
                                <textarea
                                    name="motivo"
                                    value={formData.motivo}
                                    onChange={handleChange}
                                    rows="3"
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    required
                                />
                            </div>
                            {formData.tipo === 'videoconsulta' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Notas para videoconsulta:
                                    </label>
                                    <textarea
                                        name="notas"
                                        value={formData.notas}
                                        onChange={handleChange}
                                        rows="2"
                                        placeholder="Instrucciones especiales, preparaci√≥n necesaria, etc."
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>
                            )}
                            <button
                                type="submit"
                                className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
                            >
                                üìÖ Agendar Cita
                            </button>
                        </form>
                    </div>

                    {/* Lista de citas */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h4 className="text-xl font-bold text-gray-800 mb-4">Citas Programadas</h4>
                        <div className="space-y-3">
                            {citas.map((cita, index) => (
                                <div key={index} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h5 className="font-semibold text-gray-800">{cita.paciente}</h5>
                                            <p className="text-sm text-gray-600">
                                                {cita.fecha} a las {cita.hora}
                                            </p>
                                            <p className="text-sm text-gray-600">{cita.motivo}</p>
                                            <span className={`inline-block px-2 py-1 rounded-full text-xs font-semibold mt-2 ${
                                                cita.tipo === 'videoconsulta' 
                                                    ? 'bg-purple-100 text-purple-800' 
                                                    : 'bg-green-100 text-green-800'
                                            }`}>
                                                {cita.tipo === 'videoconsulta' ? 'üìπ Videoconsulta' : 'üè• Presencial'}
                                            </span>
                                        </div>
                                        {cita.tipo === 'videoconsulta' && (
                                            <button
                                                onClick={() => window.open(generateMeetLink(cita), '_blank')}
                                                className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition duration-300"
                                            >
                                                üöÄ Iniciar Meet
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Componente principal
        const MedicalApp = () => {
            const { user, login, logout, loading, isOnline } = useAuth();
            const { historias, formulas, citas, saveHistoria, saveFormula, saveCita, refresh } = useMedicalData();
            const [activeTab, setActiveTab] = useState('dashboard');

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-purple-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Cargando...</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <LoginForm onLogin={login} />;
            }

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                { id: 'historia', label: 'Historia Cl√≠nica', icon: 'üìã' },
                { id: 'formula', label: 'F√≥rmula M√©dica', icon: 'üíä' },
                { id: 'busqueda', label: 'Buscar Paciente', icon: 'üîç' },
                { id: 'agenda', label: 'Agenda', icon: 'üìÖ' }
            ];

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center space-x-3">
                                    <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-700 rounded-full flex items-center justify-center">
                                        <span className="text-white font-bold text-lg">YS</span>
                                    </div>
                                    <div className="flex flex-col">
                                        <h1 className="text-xl font-bold text-purple-800">YoSoy</h1>
                                        <span className="text-sm text-purple-600">Historia Cl√≠nica Digital</span>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    {/* Indicador de estado de conexi√≥n */}
                                    <div className="flex items-center space-x-2">
                                        <div className={`w-3 h-3 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                        <span className={`text-xs font-medium ${isOnline ? 'text-green-600' : 'text-red-600'}`}>
                                            {isOnline ? 'En l√≠nea' : 'Sin conexi√≥n'}
                                        </span>
                                        {!isOnline && (
                                            <button 
                                                onClick={refresh}
                                                className="text-xs text-purple-600 hover:text-purple-800 underline"
                                            >
                                                Reintentar
                                            </button>
                                        )}
                                    </div>
                                    
                                    <div className="text-right">
                                        <span className="block text-sm text-purple-700 font-medium">
                                            {user.name}
                                        </span>
                                        {user.especialidad && (
                                            <span className="block text-xs text-purple-500">
                                                {user.especialidad}
                                            </span>
                                        )}
                                        {user.registro && (
                                            <span className="block text-xs text-purple-400">
                                                {user.registro}
                                            </span>
                                        )}
                                    </div>
                                    <button
                                        onClick={logout}
                                        className="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition duration-300"
                                    >
                                        Cerrar Sesi√≥n
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
                            {/* Sidebar */}
                            <div className="lg:col-span-1">
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <nav className="space-y-2">
                                        {menuItems.map((item) => (
                                            <button
                                                key={item.id}
                                                onClick={() => setActiveTab(item.id)}
                                                className={`w-full text-left px-4 py-3 rounded-lg transition duration-300 ${
                                                    activeTab === item.id
                                                        ? 'bg-purple-600 text-white'
                                                        : 'text-gray-700 hover:bg-gray-100'
                                                }`}
                                            >
                                                <span className="mr-3">{item.icon}</span>
                                                {item.label}
                                            </button>
                                        ))}
                                    </nav>
                                </div>
                            </div>

                            {/* Main Content */}
                            <div className="lg:col-span-3">
                                {activeTab === 'dashboard' && (
                                    <Dashboard historias={historias} formulas={formulas} citas={citas} />
                                )}
                                {activeTab === 'historia' && (
                                    <HistoriaClinicaForm onSave={saveHistoria} />
                                )}
                                {activeTab === 'formula' && (
                                    <FormulaMedicaForm onSave={saveFormula} currentUser={user} />
                                )}
                                {activeTab === 'busqueda' && (
                                    <BusquedaPacientes historias={historias} formulas={formulas} />
                                )}
                                {activeTab === 'agenda' && (
                                    <Agenda citas={citas} onSaveCita={saveCita} />
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Renderizar la aplicaci√≥n
        const root = createRoot(document.getElementById('app'));
        root.render(<MedicalApp />);
    </script>
</body>
</html>